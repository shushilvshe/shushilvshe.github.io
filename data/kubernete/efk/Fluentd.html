
<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/font-awesome/css/font-awesome.min.css">




    <link rel="shortcut icon" href="http://www.shushilvshe.com/images/lvcheng.jpg" type="image/x-icon">
    <link rel="icon" href="http://www.shushilvshe.com/images/lvcheng.jpg" type="image/x-icon">



<meta name="author" content="ssls" />
<meta name="description" content="fluentd.conf主要用于配置fluentd采集日志数据、处理数据、发送数据的整个生命周期规则：\n" />
<meta name="keywords" content="大数据, Fluentd">

<meta property="og:site_name" content="shushilvshe's Blog"/>
<meta property="og:title" content="Fluentd配置文件语法"/>
<meta property="og:description" content="fluentd.conf主要用于配置fluentd采集日志数据、处理数据、发送数据的整个生命周期规则：\n"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://www.shushilvshe.com/data/kubernete/efk/Fluentd.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-02-08 14:45:54+08:00"/>
<meta property="article:modified_time" content="2018-02-08 14:45:56+08:00"/>
<meta property="article:author" content="http://www.shushilvshe.com/author/ssls.html">
<meta property="article:section" content="Data"/>
<meta property="article:tag" content="大数据"/>
<meta property="article:tag" content="Fluentd"/>
<meta property="og:image" content="http://www.shushilvshe.com/images/baya.jpg">

  <title>shushilvshe's Blog &ndash; Fluentd配置文件语法</title>

</head>
<body>

  <aside>
    <div>
      <a href="http://www.shushilvshe.com">
        <img src="http://www.shushilvshe.com/images/baya.jpg" alt="数食旅摄" title="数食旅摄">
      </a>
      <h1><a href="http://www.shushilvshe.com">数食旅摄</a></h1>

<p>Data Developer</p>
      <nav>
        <ul class="list">
          <li><a href="http://www.shushilvshe.com/pages/about.html#about">About ME</a></li>

          <li><a href="/categories.html" target="_blank">Category</a></li>
          <li><a href="/tags.html" target="_blank">Tags</a></li>
          <li><a href="/archives.html" target="_blank">Archives</a></li>
        </ul>
      </nav>

      <ul class="social">
      </ul>
    </div>
    <hr margin-top=0px margin-bottom=0px>
    <p>文章目录</p>
    <hr>
    <div id="category" align="left"></div>

  </aside>
  <main>

    <nav>
      <a href="http://www.shushilvshe.com">    Home
</a>

      <a href="/category/data.html">Data</a>
      <a href="/category/food.html">Food</a>
      <a href="/category/travel.html">Travel</a>
      <a href="/">Photo</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="data/kubernete/efk/Fluentd">Fluentd配置文件语法</h1>
    <p>
          Posted on 2018-02-08(星期四) 14:45 in <a href="http://www.shushilvshe.com/category/data.html">Data</a>


    </p>
  </header>


  <div>
    <ul>
<li>source中配置数据源和匹配规则，并打上标识tag </li>
<li>filter中配置处理规则，对与匹配tag的数据进行过滤、处理 </li>
<li>match中配置数据存储目标，将符合tag的数据发送至指定目标存储，比如elasticsearch、mongodb等。</li>
</ul>
<p>fluentd.conf主要用于配置fluentd采集日志数据、处理数据、发送数据的整个生命周期规则：</p>
<ul>
<li>source中配置数据源和匹配规则，并打上标识tag</li>
<li>filter中配置处理规则，对与匹配tag的数据进行过滤、处理</li>
<li>match中配置数据存储目标，将符合tag的数据发送至指定目标存储，比如elasticsearch、mongodb等。</li>
</ul>
<h2>语法</h2>
<h3>指令列表</h3>
<p>fluentd.conf配置文件包括以下可用指令：</p>
<ul>
<li>source指令确定输入源</li>
<li>match指令确定输出目标</li>
<li>filter指令确定事件处理管道</li>
<li>system指令设置系统配置</li>
<li>label指令对输出和过滤器进行分组以用于内部路由</li>
<li>@include指令用于包括其他文件</li>
</ul>
<p>下面一步一步创建一个配置文件：</p>
<p><strong>（1）source</strong></p>
<p>source 告诉Fluentd数据从哪来， 配置数据从哪输入，默认自带两种 <code>http</code> 和 <code>forward</code>, http主要用于接收http请求，forward主要用于接受tcp数据包。</p>
<p>例如：</p>
<div class="highlight"><pre><span></span>Receive events from 24224/tcp
This is used by log forwarding and the fluent-cat command
<span class="nt">&lt;source&gt;</span>
  @type forward
  port 24224
<span class="nt">&lt;/source&gt;</span>

http://this.host:9880/myapp.access?json={&quot;event&quot;:&quot;data&quot;}
<span class="nt">&lt;source&gt;</span>
  @type http
  port 9880
<span class="nt">&lt;/source&gt;</span>
</pre></div>


<p>source 指令中必须有type参数，type参数指明使用的input插件。source 指令会提交事件（event）给Fluentd的路由引擎，事件由三个实体组成：<code>标签（tag）</code>、<code>时间（time）</code>、<code>记录（record）</code>。标签（tag）是 由点（.）分隔的字符串，如：myapp.access，在内部路由引擎中起到区分、指示路由的作用。时间（time）字段由输入插件指定，它必须是Unix时间格式。 记录（record）是一个JSON对象。可以同时配置使用多个输入插件，对插件的使用数量并无上限，主要会受到机器本身配置和实际业务场景限制。</p>
<blockquote>
<p>由于标签（tag）一般会在整个配置的不同上下文中使用，因此强烈建议标签以小写字母、数字和下划线命名，如：^[a-z0-9_]+$。</p>
</blockquote>
<p>对于上面的例子，HTTP输入插件提交以下事件：</p>
<div class="highlight"><pre><span></span># generated by http://this.host:9880/myapp.access?json={&quot;event&quot;:&quot;data&quot;}
tag: myapp.access
time: (current time)
record: {&quot;event&quot;:&quot;data&quot;}
</pre></div>


<p><strong>（2）match</strong></p>
<p>match 指令用于查找匹配相应标签（tag）的事件（event），并对匹配事件进行处理。match 指令最常见的用法是将事件（event）输出到其他系统中（由于这个原因，与 match 指令相对应的插件称为输出插件）。与前文提到的输入插件类似，Fluentd也可以通过安装相应的输出插件来增强输出功能。Fluentd标准的输出插件包含 <code>file</code> 和 <code>forward</code> ，无需额外安装即可使用。</p>
<p>我们试着在之前的配置文件中添加输出插件：</p>
<div class="highlight"><pre><span></span># Receive events from 24224/tcp
# This is used by log forwarding and the fluent-cat command
<span class="nt">&lt;source&gt;</span>
  @type forward
  port 24224
<span class="nt">&lt;/source&gt;</span>

# http://this.host:9880/myapp.access?json={&quot;event&quot;:&quot;data&quot;}
<span class="nt">&lt;source&gt;</span>
  @type http
  port 9880
<span class="nt">&lt;/source&gt;</span>

# Match events tagged with &quot;myapp.access&quot; and
# store them to /var/log/fluent/access.%Y-%m-%d
# Of course, you can control how you partition your data
# with the time_slice_format option.
<span class="nt">&lt;match</span> <span class="err">myapp.access</span><span class="nt">&gt;</span>
  @type file
  path /var/log/fluent/access
<span class="nt">&lt;/match&gt;</span>
</pre></div>


<p>每一个 match 指令必须包括匹配模式和 type 参数。只有标签（tag）和匹配模式匹配的事件（event）才会输出到指定目标（在上面的例子中， 只有当事件的标签是 myapp.access 时，才能符合匹配模式）。type 参数表示当前使用的输出插件类型。</p>
<blockquote>
<p>与输入插件一样，Fluentd也提供了丰富的output插件，请 <a href="http://www.fluentd.org/plugins/all#input-output">点击这里</a> 访问。当然，也可以自己开发输出插件。</p>
</blockquote>
<p><strong>匹配模式（Match Pattern）</strong></p>
<p>match 中可以使用以下匹配模式（Match Pattern）：</p>
<ul>
<li>
<p><code>*</code> 匹配单个标签（tag）部分</p>
<ul>
<li>例如：模式 <code>a.*</code> 能匹配 <code>a.b</code> ，但不能匹配 <code>a</code> 或 <code>a.b.c</code></li>
</ul>
</li>
<li>
<p><code>**</code> 匹配零或多个标签（tag）部分</p>
<ul>
<li>例如：模式 <code>a.**</code> 能匹配 <code>a</code> 、 <code>a.b</code> 、 <code>a.b.c</code></li>
</ul>
</li>
<li>
<p><code>{X,Y,Z}</code> 匹配X，Y或Z，其中X、Y、Z是匹配模式</p>
<ul>
<li>例如：模式 <code>{a,b}</code> 匹配 <code>a</code> 和 <code>b</code> ，但不能匹配 <code>c</code></li>
<li>可以同时跟 <code>*</code> 和 <code>**</code> 结合使用。例如： <code>a.{b,c}.*</code> 、 <code>a.{b,c.**}</code></li>
</ul>
</li>
<li>
<p>当一个<match>标签中有多个匹配模式（匹配模式由一个或多个空格分隔）时，会匹配其中任何一个模式。</p>
<ul>
<li>例如：模式 <code>&lt;match a b&gt;</code> 匹配 <code>a</code> 和 <code>b</code></li>
<li>例如：模式 <code>&lt;match a.** b.**&gt;</code> 匹配 <code>a</code> 、 <code>a.b</code> 、 <code>a.b.c</code> 以及 <code>b.d</code></li>
</ul>
</li>
</ul>
<p><strong>匹配顺序（Match Order）</strong></p>
<p>Fluentd会尝试按照 match 在配置文件中出现的顺序来匹配标签（tag）。所以，对于以下配置：</p>
<div class="highlight"><pre><span></span># ** matches all tags. Bad :(
<span class="nt">&lt;match</span> <span class="err">**</span><span class="nt">&gt;</span>
  @type blackhole_plugin
<span class="nt">&lt;/match&gt;</span>

<span class="nt">&lt;match</span> <span class="err">myapp.access</span><span class="nt">&gt;</span>
  @type file
  path /var/log/fluent/access
<span class="nt">&lt;/match&gt;</span>
</pre></div>


<p>myapp.access 永远不会被匹配到，应该将范围大的匹配模式（Wider Match Patterns）放在范围小的匹配模式（Tight Match Patterns）后面。</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;match</span> <span class="err">myapp.access</span><span class="nt">&gt;</span>
  @type file
  path /var/log/fluent/access
<span class="nt">&lt;/match&gt;</span>

# Capture all unmatched tags. Good :)
<span class="nt">&lt;match</span> <span class="err">**</span><span class="nt">&gt;</span>
  @type blackhole_plugin
<span class="nt">&lt;/match&gt;</span>
</pre></div>


<p>当然，如果你有两个相同的匹配模式，那么第二个匹配模式永远不会被匹配到。</p>
<p>如果你希望同时发送事件（events）到多个输出目标，可以考虑使用 out_copy 插件。访问 <a href="http://www.fluentd.org/plugins/all#input-output">插件列表</a> 。</p>
<p><strong>（3）filter</strong></p>
<p>filter 指令的语法和 match 指令相同，但是 filter 可以被链接处理管道。使用过滤器，事件流如下：</p>
<div class="highlight"><pre><span></span>Input -&gt; filter 1 -&gt; ... -&gt; filter N -&gt; Output
</pre></div>


<p>下面我们添加标准的 record_transformer 过滤器到之前的匹配示例中：</p>
<div class="highlight"><pre><span></span># http://this.host:9880/myapp.access?json={&quot;event&quot;:&quot;data&quot;}
<span class="nt">&lt;source&gt;</span>
  @type http
  port 9880
<span class="nt">&lt;/source&gt;</span>

<span class="nt">&lt;filter</span> <span class="err">myapp.access</span><span class="nt">&gt;</span>
  @type record_transformer
  <span class="nt">&lt;record&gt;</span>
    host_param &quot;#{Socket.gethostname}&quot;
  <span class="nt">&lt;/record&gt;</span>
<span class="nt">&lt;/filter&gt;</span>

<span class="nt">&lt;match</span> <span class="err">myapp.access</span><span class="nt">&gt;</span>
  @type file
  path /var/log/fluent/access
<span class="nt">&lt;/match&gt;</span>
</pre></div>


<p>接收事件 {"event":"data"} ，先到 record_transformer 过滤器，record_transformer 过滤器将host_param字段添加到事件中， 过滤后的事件是 {"event":"data","host_param":"webserver1"} ，然后过滤后的事件输出到文件中。</p>
<blockquote>
<p>Filter的匹配顺序和Output相同，而且应该将<filter>放至<match>前面。</p>
</blockquote>
<p><strong>（4）system</strong></p>
<p>system 指令可以设置以下配置，也可以通过Fluentd的选项来设置：</p>
<ul>
<li>log_level</li>
<li>suppress_repeated_stacktrace</li>
<li>emit_error_log_interval</li>
<li>suppress_config_dump</li>
<li>without_source</li>
<li>process_name (只能通过 system 指令设置，不能通过fluentd或Fluentd选项设置)</li>
</ul>
<p>下面是一个例子：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;system&gt;</span>
  # equal to -qq option
  log_level error
  # equal to --without-source option
  without_source
  # ...
<span class="nt">&lt;/system&gt;</span>
</pre></div>


<p>如果设置了process_name，将会改变Fluentd的supervisor和worker process名称。</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;system&gt;</span>
  process_name fluentd1
<span class="nt">&lt;/system&gt;</span>
</pre></div>


<p>如果配置了该项，ps 命令会显示以下结果：</p>
<div class="highlight"><pre><span></span><span class="c">% ps aux | grep fluentd1</span>
<span class="n">foo</span>      <span class="mi">45673</span>   <span class="mf">0.4</span>  <span class="mf">0.2</span>  <span class="mi">2523252</span>  <span class="mi">38620</span> <span class="n">s001</span>  <span class="n">S</span><span class="o">+</span>    <span class="mi">7</span><span class="p">:</span><span class="mi">04</span><span class="n">AM</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">00.44</span> <span class="n">worker</span><span class="p">:</span><span class="n">fluentd1</span>
<span class="n">foo</span>      <span class="mi">45647</span>   <span class="mf">0.0</span>  <span class="mf">0.1</span>  <span class="mi">2481260</span>  <span class="mi">23700</span> <span class="n">s001</span>  <span class="n">S</span><span class="o">+</span>    <span class="mi">7</span><span class="p">:</span><span class="mi">04</span><span class="n">AM</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">00.40</span> <span class="n">supervisor</span><span class="p">:</span><span class="n">fluentd1</span>
</pre></div>


<blockquote>
<p>该功能需要ruby 2.1及以上版本支持。</p>
</blockquote>
<p><strong>（5）label</strong></p>
<p>label 指令对filter和output进行分组以便于内部路由。label 降低了标签（tag）处理的复杂性。</p>
<p>下面是一个示例，由于 label 是内置的插件参数，需要加 @ 作为前缀：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;source&gt;</span>
  @type forward
<span class="nt">&lt;/source&gt;</span>

<span class="nt">&lt;source&gt;</span>
  @type tail
  @label @SYSTEM
<span class="nt">&lt;/source&gt;</span>

<span class="nt">&lt;filter</span> <span class="err">access.**</span><span class="nt">&gt;</span>
  @type record_transformer
  <span class="nt">&lt;record&gt;</span>
    # ...
  <span class="nt">&lt;/record&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;match</span> <span class="err">**</span><span class="nt">&gt;</span>
  @type elasticsearch
  # ...
<span class="nt">&lt;/match&gt;</span>

<span class="nt">&lt;label</span> <span class="err">@SYSTEM</span><span class="nt">&gt;</span>
  <span class="nt">&lt;filter</span> <span class="err">var.log.middleware.**</span><span class="nt">&gt;</span>
    @type grep
    # ...
  <span class="nt">&lt;/filter&gt;</span>
  <span class="nt">&lt;match</span> <span class="err">**</span><span class="nt">&gt;</span>
    @type s3
    # ...
  <span class="nt">&lt;/match&gt;</span>
<span class="nt">&lt;/label&gt;</span>
</pre></div>


<p>在上面配置中，forward 事件被路由到 record_transformer 过滤器和 elasticsearch 输出，in_tail 事件被路由到 @SYSTEM 标签内部的 grep 过滤器和 s3 输出。</p>
<p>label 对于没有标签（tag）前缀的的事件流分离是很有用的。</p>
<blockquote>
<p>label和tag都有标签的意思，为了加以区分，可以将tag翻译成标签，将label翻译成标记或者标注。
@ERROR 标记（Label）是用于由插件 emit_error_event API发出的错误记录的内置标记。如果在配置中配置了 <label @ERROR> ，那么当发生相关错误时，事件将路由到此标签。例如：缓冲区已满（buffer is full）或无效记录（invalid record）。</p>
</blockquote>
<p><strong>（6）@include</strong></p>
<p>可以使用 <code>@include</code> 指令导入其他配置文件中的指令：</p>
<div class="highlight"><pre><span></span># Include config files in the ./config.d directory
@include config.d/*.conf
</pre></div>


<p><code>@include</code> 指令支持常规的文件路径、glob模式和HTTP URL约定：</p>
<div class="highlight"><pre><span></span># absolute path
@include /path/to/config.conf

# if using a relative path, the directive will use
# the dirname of this config file to expand the path
@include extra.conf

# glob match pattern
@include config.d/*.conf

# http
@include http://example.com/fluent.conf
</pre></div>


<p>对于glob模式，文件以字母顺序扩展。如果有 a.conf 和 b.conf ，Fluentd会首先解析 a.conf 。但是不建议按照这个顺序来编写配置文件，因为这很容易出错。为了安全起见，应该分开写：</p>
<div class="highlight"><pre><span></span># If you have a.conf,b.conf,...,z.conf and a.conf / z.conf are important...

# This is bad
@include *.conf

# This is good
@include a.conf
@include config.d/*.conf
@include z.conf
</pre></div>


<h2>参考文档</h2>
<p><a href="http://docs.saas.hand-china.com/docs/hitoa/zh_CN/latest/user-guide/log-aggregation-analysis/td-agent-config-file-syntax.html">td-agent配置文件语法</a></p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://www.shushilvshe.com/tag/da-shu-ju.html">大数据</a>
      <a href="http://www.shushilvshe.com/tag/fluentd.html">Fluentd</a>
    </p>
  </div>



    <div class="addthis_relatedposts_inline">


</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " shushilvshe's Blog ",
  "url" : "http://www.shushilvshe.com",
  "image": "http://www.shushilvshe.com/images/baya.jpg",
  "description": "shushilvshe's Thoughts and Writings"
}
</script>

</body>
</html>