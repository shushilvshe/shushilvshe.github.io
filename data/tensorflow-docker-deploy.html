
<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/font-awesome/css/font-awesome.min.css">




    <link rel="shortcut icon" href="http://www.shushilvshe.com/images/lvcheng.jpg" type="image/x-icon">
    <link rel="icon" href="http://www.shushilvshe.com/images/lvcheng.jpg" type="image/x-icon">



<meta name="author" content="ssls" />
<meta name="description" content="制作包含有nvidia cuda、cudnn环境的tensorflow-gpu镜像包，并通过portainer手动单点配置及kubernetes集群管理两种方式进行部署。" />
<meta name="keywords" content="深度学习, docker, tensorflow, kubernetes">

<meta property="og:site_name" content="shushilvshe's Blog"/>
<meta property="og:title" content="tensorflow-gpu-docker镜像安装及部署文档"/>
<meta property="og:description" content="制作包含有nvidia cuda、cudnn环境的tensorflow-gpu镜像包，并通过portainer手动单点配置及kubernetes集群管理两种方式进行部署。"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://www.shushilvshe.com/data/tensorflow-docker-deploy.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-12-15 18:01:03+08:00"/>
<meta property="article:modified_time" content="2018-02-22 14:08:17+08:00"/>
<meta property="article:author" content="http://www.shushilvshe.com/author/ssls.html">
<meta property="article:section" content="Data"/>
<meta property="article:tag" content="深度学习"/>
<meta property="article:tag" content="docker"/>
<meta property="article:tag" content="tensorflow"/>
<meta property="article:tag" content="kubernetes"/>
<meta property="og:image" content="http://www.shushilvshe.com/images/baya.jpg">

  <title>shushilvshe's Blog &ndash; tensorflow-gpu-docker镜像安装及部署文档</title>

</head>
<body>

  <aside>
    <div style="background-image: url('http://www.shushilvshe.com/images/xianer.jpg')">
      <a href="http://www.shushilvshe.com">
        <img src="http://www.shushilvshe.com/images/baya.jpg" alt="数食旅摄" title="数食旅摄">
      </a>
      <h1><a href="http://www.shushilvshe.com">数食旅摄</a></h1>

<p>Data Developer</p>
      <nav>
        <ul class="list">
          <li><a href="http://www.shushilvshe.com/pages/about.html#about">About ME</a></li>

          <li><a href="/categories.html" target="_blank">Category</a></li>
          <li><a href="/tags.html" target="_blank">Tags</a></li>
          <li><a href="/archives.html" target="_blank">Archives</a></li>
        </ul>
      </nav>

      <ul class="social">
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="http://www.shushilvshe.com">    Home
</a>

      <a href="/category/data.html">Data</a>
      <a href="/category/food.html">Food</a>
      <a href="/category/travel.html">Travel</a>
      <a href="/">Photo</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="data/tensorflow-docker-deploy">tensorflow-gpu-docker镜像安装及部署文档</h1>
    <p>
          Posted on 2017-12-15(星期五) 18:01 in <a href="http://www.shushilvshe.com/category/data.html">Data</a>


    </p>
  </header>


  <div>
    <p><link rel="stylesheet" href="http://yandex.st/highlightjs/6.2/styles/googlecode.min.css"></p>
<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>

<script src="http://yandex.st/highlightjs/6.2/highlight.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>

<script type="text/javascript">
 $(document).ready(function(){
      $("h2,h3,h4,h5,h6").each(function(i,item){
        var tag = $(item).get(0).localName;
        $(item).attr("id","wow"+i);
        $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
        $(".newh2").css("margin-left",0);
        $(".newh3").css("margin-left",20);
        $(".newh4").css("margin-left",40);
        $(".newh5").css("margin-left",60);
        $(".newh6").css("margin-left",80);
      });
 });
</script>

<div id="category"></div>

<h2>基本环境</h2>
<ul>
<li>tensorflow-gpu 1.4.1</li>
<li>cuda8</li>
<li>cudnn6</li>
<li>centos7</li>
<li>python 3.6.2</li>
<li>portainer 1.15.5 （轻量级docker集群管理平台）</li>
<li>harbor 1.1.2 （用于存储和分发Docker镜像的企业级Registry服务器）</li>
<li>kubernetes 1.8.3 (企业级容器集群管理系统)</li>
</ul>
<h2>前置条件</h2>
<ul>
<li>安装docker （docker-ce 17.09 版本）, 过程参照 <a href="http://www.shushilvshe.com/data/docker.html#wow8">[docker安装]</a></li>
<li>安装kubernetes 1.8.3，过程参照 <a href="http://www.shushilvshe.com/data/kubernete-installation.html#data/kubernete-installation">[kubernetes（1.8.3）系列之安装]</a></li>
<li>安装portainer，过程参照 <a href="https://portainer.readthedocs.io/en/stable/deployment.html">[Deployment]</a></li>
<li>安装Harbor， 过程参照  <a href="http://blog.csdn.net/a632189007/article/details/78777224">[搭建docker私有仓库 -- Harbor]</a></li>
<li>节点互信，过程参照 [<a href="http://www.shushilvshe.com/data/docker-ssh.html#data/docker-ssh">制作ssh互信的docker镜像</a>]</li>
</ul>
<h2>制作tensorflow-gpu docker镜像</h2>
<h3>拉取并启动基础镜像—— <code>nvidia/cuda:8.0-cudnn6-runtime-centos7</code></h3>
<ul>
<li>
<p>获取nvidia/cuda镜像</p>
<div class="highlight"><pre><span></span>docker pull nvidia/cuda:8.0-cudnn6-runtime-centos7
</pre></div>


</li>
<li>
<p>运行nvidia/cuda镜像</p>
<div class="highlight"><pre><span></span>docker run -it -v /data:/host_data nvidia/cuda:8.0-cudnn6-runtime-centos7 /bin/bash
</pre></div>


</li>
</ul>
<h3>编译安装python 3.6.2， 过程参照 <a href="http://www.shushilvshe.com/data/dl-env-build.html#wow8">[python编译安装]</a></h3>
<h3>1.安装tensorflow-gpu 1.4.1</h3>
<div class="highlight"><pre><span></span>pip3 install -U scikit-image -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install -U h5py -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install -U scipy -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install -U imageio -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install -U tensorflow-gpu==1.4.1 -i https://pypi.tuna.tsinghua.edu.cn/simple
</pre></div>


<h3>2.安装openmpi-2.1.2</h3>
<p>[<a href="https://www.open-mpi.org/software/ompi/v2.1/downloads/openmpi-2.1.2.tar.gz">官网下载</a>] <br>
网盘下载： [<a href="https://drive.google.com/open?id=1M1pzafmZzK2-LtJ45kGJWZigUeBx89xy">google drive</a>] [<a href="https://pan.baidu.com/s/1dHgynKX">百度网盘</a>]</p>
<blockquote>
<p>注意, 目前openmpi已经有3.0版本,但是tensorflow目前还是只认2.0版本。</p>
</blockquote>
<p>在宿主机上下载openmpi-2.1.2, 编译，然后将<code>openmpi-2.1.2</code>文件夹拷贝到镜像的 <code>/usr/local/</code> 目录下。</p>
<div class="highlight"><pre><span></span>tar -zxvf openmpi-2.1.2.tar.gz
cd openmpi-2.1.2
./configure --prefix=/usr/local/openmpi-2.1.2 --enable-static --with-cuda   后面的参数很重要
make all install
</pre></div>


<p>在~/.bashrc中加入：</p>
<div class="highlight"><pre><span></span><span class="x">export OPENMPI=/usr/local/openmpi-2.1.2</span>
<span class="x">export LD_LIBRARY_PATH=</span><span class="p">$</span><span class="nv">OPENMPI</span><span class="x">/lib:</span><span class="p">$</span><span class="nv">LD_LIBRARY_PATH</span><span class="x"></span>
<span class="x">export PATH=</span><span class="p">$</span><span class="nv">OPENMPI</span><span class="x">/bin:</span><span class="p">$</span><span class="nv">PATH</span><span class="x"></span>
</pre></div>


<h3>3.安装nccl_2.1.2-1</h3>
<p>[<a href="https://developer.nvidia.com/nccl/nccl-download">官网下载</a>]</p>
<blockquote>
<p>下载nccl需要注册nvidia账号，免费的。或者从我备份的网盘下载：<a href="https://drive.google.com/open?id=1fbKU9YbuVU-V9575jwQ_vWpe6idHZy1D">[google drive]</a>  <a href="https://pan.baidu.com/s/1i6lz6FN">[百度网盘]</a></p>
</blockquote>
<div class="highlight"><pre><span></span>tar -xvf nccl_2.1.2-1.txz
cp -r ./nccl_2.1.2-1 /usr/local
</pre></div>


<p>在 <strong>LD_LIBRARY_PATH</strong> 加入 <code>/usr/local/nccl_2.1.2-1/lib</code></p>
<p><strong>很重要!!  在~/.bash下加入: (enp2s0修改为自己网卡的名称)</strong></p>
<div class="highlight"><pre><span></span>export NCCL_SOCKET_IFNAME=enp2s0
</pre></div>


<blockquote>
<p>声明NCCL使用socket通讯使用的网卡. 使用 ^ 符合,表示非的意思. 比如export NCCL_SOCKET_IFNAME=^enp2s0, 排除enp2s0网卡</p>
</blockquote>
<h3>4.安装horovod</h3>
<blockquote>
<p>在安装之前,确保cuda, tensorflow, openmpi已经安装,并且各种lib在已经在LD_LIBRARY_PATH中,然后执行</p>
</blockquote>
<div class="highlight"><pre><span></span>HOROVOD_NCCL_HOME=/usr/local/nccl_2.1.2-1 HOROVOD_GPU_ALLREDUCE=NCCL pip3 install --no-cache-dir horovod
</pre></div>


<h3>5.拷贝库文件</h3>
<p>原cuda环境没有libcuda.so和libnvidia-fatbinaryloader.so的库文件，将宿主机上的 <code>lib64</code> 或 <code>/usr/lib64</code> 文件夹下的如下文件拷贝到镜像中的 <code>/lib64</code>目录下即可。</p>
<div class="highlight"><pre><span></span>lrwxrwxrwx 1 root root       12 Feb 22 10:03 libcuda.so -&gt; libcuda.so.1
lrwxrwxrwx 1 root root       17 Feb 22 10:03 libcuda.so.1 -&gt; libcuda.so.384.69
-rwxr-xr-x 1 root root 13030360 Feb 22 10:03 libcuda.so.384.69
-rwxr-xr-x 1 root root   313832 Feb 22 10:06 libnvidia-fatbinaryloader.so.384.69
</pre></div>


<h3>6.将新环境打成新镜像包</h3>
<h4>查询当前 CONTAINER ID</h4>
<div class="highlight"><pre><span></span>[root@gpu187 ~]# docker ps 
CONTAINER ID        IMAGE                                                        COMMAND                  CREATED             STATUS              PORTS               NAMES
4e5918306494        192.168.1.184:5000/nvidia/cuda:8.0-cudnn6-runtime-centos7   &quot;/bin/bash&quot;              4 minutes ago       Up 4 minutes                            ecstatic_saha
</pre></div>


<h4>保存新镜像</h4>
<div class="highlight"><pre><span></span>docker commit 4e5918306494 tensorflow-gpu-1.4.1-py36:1.0.0
</pre></div>


<h4>上传镜像到本地仓库</h4>
<p>打开portainer管理界面， 在左侧边框选择 endpoint-&gt; images，右侧会显示出刚保存的新镜像</p>
<p><center><img src="https://i.imgur.com/AEUZyjh.jpg" width="1440"/></center></p>
<p>点击镜像id进去，在右侧界面选择仓库，输入tag name，点击Tag就可以在界面上方生成一个新tag（PS：示意图为之前打好的tag，所以上方只有一个tag，仅做说明界面用），点击 “上箭头” 符号，一两分钟后便可以上传到本地镜像仓库中。</p>
<p><center><img src="https://i.imgur.com/Ni9qW6H.jpg" width="1440"/></center></p>
<p><center><img src="https://i.imgur.com/tJqdDMC.jpg" width="1440"/></center></p>
<h2>部署镜像并启动训练模型任务</h2>
<h3>使用 portainer 单点部署</h3>
<p>进入portainer管理界面，左侧选择Containers，右侧点击Add container</p>
<p><center><img src="https://i.imgur.com/7QbxZAF.jpg" width="1440"/></center></p>
<p>填入容器名称，选择镜像，在Command一栏输入需要执行的脚本，还有工作目录。</p>
<p><center><img src="https://i.imgur.com/VpbK8qG.jpg" width="1440"/></center></p>
<p>挂载本地Volumn，（主要是nvidia cuda库）</p>
<p><center><img src="https://i.imgur.com/o9mw2Wt.jpg" width="1440"/></center></p>
<p>在Env中配置显卡id， <code>CUDA_VISIABLE_DEVIDE</code>为0，使用第一块儿显卡</p>
<p><center><img src="https://i.imgur.com/sQgGZSv.jpg" width="1440"/></center></p>
<p>启用特权权限，点击部署容器就可以了。（PS:启动之后，可以从容器界面看启动的状态）</p>
<p><center><img src="https://i.imgur.com/VzRvThe.jpg" width="1440"/></center></p>
<h3>使用 Kubernetes 自动集群部署</h3>
<p>在Kubernetes dashboard中，点击右上角添加，选择上传yaml文件，选择本地yaml文件后，点击上传就可以了（相当于运行 <code>kubectl  create -f xxx.yaml</code>）</p>
<p><center><img src="https://i.imgur.com/23GxwRM.jpg" width="1440"/></center></p>
<ul>
<li>yaml配置文件示例<div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">extensions</span><span class="sr">/v1beta1    # Deployment 对应的是 extensions/</span><span class="n">v1beta1</span> <span class="err">版本</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span> 
  <span class="n">labels</span><span class="o">:</span>  
    <span class="n">app</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>  
  <span class="n">name</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>  
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">bigdata</span>
<span class="n">spec</span><span class="o">:</span>  
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">1</span>  
  <span class="n">selector</span><span class="o">:</span>  
    <span class="n">matchLabels</span><span class="o">:</span>  
      <span class="n">app</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>
  <span class="n">template</span><span class="o">:</span>  
    <span class="n">metadata</span><span class="o">:</span>  
      <span class="n">labels</span><span class="o">:</span>  
        <span class="n">app</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span> 
    <span class="n">spec</span><span class="o">:</span>  
      <span class="n">containers</span><span class="o">:</span> 
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span> 
        <span class="n">image</span><span class="o">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.184</span><span class="o">:</span><span class="mi">5000</span><span class="sr">/bigdata/</span><span class="n">tensorflow</span><span class="o">-</span><span class="n">gpu</span><span class="o">-</span><span class="n">py2</span><span class="o">:</span><span class="mf">1.3</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">gpu</span>
        <span class="n">workingDir</span><span class="o">:</span> <span class="sr">/ceph/docker/katong_2_lemiao/</span>
        <span class="n">resources</span><span class="o">:</span> 
          <span class="n">limits</span><span class="o">:</span> 
            <span class="n">alpha</span><span class="o">.</span><span class="na">kubernetes</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">nvidia</span><span class="o">-</span><span class="n">gpu</span><span class="o">:</span> <span class="mi">1</span>   
        <span class="err">#</span> <span class="n">env</span><span class="o">:</span>
        <span class="err">#</span> <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">CUDA_VISIBLE_DEVICES</span>
        <span class="err">#</span>   <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;0&quot;</span>   <span class="err">#</span><span class="n">kubernetes</span> <span class="mf">1.5</span><span class="o">.</span><span class="mi">2</span><span class="err">版本只能识别一台机器中的一张显卡</span>
        <span class="n">command</span><span class="o">:</span> 
        <span class="o">-</span> <span class="o">./</span><span class="n">run</span><span class="o">.</span><span class="na">sh</span>
        <span class="n">ports</span><span class="o">:</span>  
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">8088</span>  
          <span class="n">protocol</span><span class="o">:</span> <span class="n">TCP</span>  
        <span class="err">#</span><span class="n">livenessProbe</span><span class="o">:</span>  
        <span class="err">#</span>  <span class="n">httpGet</span><span class="o">:</span>  
        <span class="err">#</span>    <span class="n">path</span><span class="o">:</span> <span class="o">/</span>  
        <span class="err">#</span>    <span class="n">port</span><span class="o">:</span> <span class="mi">8088</span>  
        <span class="err">#</span>  <span class="n">initialDelaySeconds</span><span class="o">:</span> <span class="mi">30</span>
        <span class="err">#</span>  <span class="n">timeoutSeconds</span><span class="o">:</span> <span class="mi">30</span> 
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/ceph/</span><span class="n">docker</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">zi</span><span class="o">-</span><span class="n">data</span>
        <span class="o">-</span> <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/usr/local/</span><span class="n">nvidia</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">nvidia</span><span class="o">-</span><span class="n">driver</span>
        <span class="o">-</span> <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/sys/fs/</span><span class="n">cgroup</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">cgroup</span>
      <span class="err">#</span> <span class="n">nodeName</span><span class="o">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.186</span>      <span class="err">#</span>
      <span class="n">volumes</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">hostPath</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="sr">/ceph/</span><span class="n">docker</span>
        <span class="n">name</span><span class="o">:</span> <span class="n">zi</span><span class="o">-</span><span class="n">data</span>
      <span class="o">-</span> <span class="n">hostPath</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="sr">/var/lib/nvidia-docker/volumes/nvidia_driver/</span><span class="mf">384.69</span>
        <span class="n">name</span><span class="o">:</span> <span class="n">nvidia</span><span class="o">-</span><span class="n">driver</span>
      <span class="o">-</span> <span class="n">hostPath</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="sr">/sys/fs/</span><span class="n">cgroup</span>
        <span class="n">name</span><span class="o">:</span> <span class="n">cgroup</span>

<span class="o">---</span>  
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>  
<span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>  
<span class="n">metadata</span><span class="o">:</span>  
  <span class="n">labels</span><span class="o">:</span>  
    <span class="n">app</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>  
  <span class="n">name</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>  
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">bigdata</span>
<span class="n">spec</span><span class="o">:</span>  
  <span class="n">type</span><span class="o">:</span> <span class="n">NodePort</span>  
  <span class="n">ports</span><span class="o">:</span> 
  <span class="o">-</span> <span class="n">port</span><span class="o">:</span> <span class="mi">8088</span>  
    <span class="n">targetPort</span><span class="o">:</span> <span class="mi">8088</span> 
    <span class="n">nodePort</span><span class="o">:</span> <span class="mi">30009</span>
  <span class="n">selector</span><span class="o">:</span>  
    <span class="n">app</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>
</pre></div>


</li>
</ul>
<h2>问题集锦</h2>
<p>1.docker启动tensorflow session报错： <code>failed call to cuInit: CUDA_ERROR_UNKNOWN</code>, 如下：</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@466ad9c0689b</span> <span class="n">python3</span><span class="p">]</span><span class="c1"># python3</span>
<span class="n">Python</span> <span class="mf">3.6</span><span class="o">.</span><span class="mi">2</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Feb</span> <span class="mi">11</span> <span class="mi">2018</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">37</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.8</span><span class="o">.</span><span class="mi">5</span> <span class="mi">20150623</span> <span class="p">(</span><span class="n">Red</span> <span class="n">Hat</span> <span class="mf">4.8</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="mi">16</span><span class="p">)]</span> <span class="n">on</span> <span class="n">linux</span>
<span class="n">Type</span> <span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="s2">&quot;copyright&quot;</span><span class="p">,</span> <span class="s2">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s2">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">python3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">6</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">h5py</span><span class="o">/</span><span class="n">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span> <span class="ne">FutureWarning</span><span class="p">:</span> <span class="n">Conversion</span> <span class="n">of</span> <span class="n">the</span> <span class="n">second</span> <span class="n">argument</span> <span class="n">of</span> <span class="n">issubdtype</span> <span class="kn">from</span> <span class="sb">`float`</span> <span class="n">to</span> <span class="sb">`np.floating`</span> <span class="ow">is</span> <span class="n">deprecated</span><span class="o">.</span> <span class="n">In</span> <span class="n">future</span><span class="p">,</span> <span class="n">it</span> <span class="n">will</span> <span class="n">be</span> <span class="n">treated</span> <span class="k">as</span> <span class="sb">`np.float64 == np.dtype(float).type`</span><span class="o">.</span>
  <span class="kn">from</span> <span class="nn">._conv</span> <span class="kn">import</span> <span class="n">register_converters</span> <span class="k">as</span> <span class="n">_register_converters</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="mi">2018</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">22</span> <span class="mo">04</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">12.427870</span><span class="p">:</span> <span class="n">I</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="n">cpu_feature_guard</span><span class="o">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">137</span><span class="p">]</span> <span class="n">Your</span> <span class="n">CPU</span> <span class="n">supports</span> <span class="n">instructions</span> <span class="n">that</span> <span class="n">this</span> <span class="n">TensorFlow</span> <span class="n">binary</span> <span class="n">was</span> <span class="ow">not</span> <span class="n">compiled</span> <span class="n">to</span> <span class="n">use</span><span class="p">:</span> <span class="n">SSE4</span><span class="o">.</span><span class="mi">1</span> <span class="n">SSE4</span><span class="o">.</span><span class="mi">2</span> <span class="n">AVX</span> <span class="n">AVX2</span> <span class="n">FMA</span>
<span class="mi">2018</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">22</span> <span class="mo">04</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">12.430545</span><span class="p">:</span> <span class="n">E</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">stream_executor</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">cuda_driver</span><span class="o">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">406</span><span class="p">]</span> <span class="n">failed</span> <span class="n">call</span> <span class="n">to</span> <span class="n">cuInit</span><span class="p">:</span> <span class="n">CUDA_ERROR_UNKNOWN</span>
<span class="mi">2018</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">22</span> <span class="mo">04</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">12.430672</span><span class="p">:</span> <span class="n">I</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">stream_executor</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">cuda_diagnostics</span><span class="o">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">158</span><span class="p">]</span> <span class="n">retrieving</span> <span class="n">CUDA</span> <span class="n">diagnostic</span> <span class="n">information</span> <span class="k">for</span> <span class="n">host</span><span class="p">:</span> <span class="mi">466</span><span class="n">ad9c0689b</span>
<span class="mi">2018</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">22</span> <span class="mo">04</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">12.430715</span><span class="p">:</span> <span class="n">I</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">stream_executor</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">cuda_diagnostics</span><span class="o">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">165</span><span class="p">]</span> <span class="n">hostname</span><span class="p">:</span> <span class="mi">466</span><span class="n">ad9c0689b</span>
<span class="mi">2018</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">22</span> <span class="mo">04</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">12.430840</span><span class="p">:</span> <span class="n">I</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">stream_executor</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">cuda_diagnostics</span><span class="o">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">189</span><span class="p">]</span> <span class="n">libcuda</span> <span class="n">reported</span> <span class="n">version</span> <span class="ow">is</span><span class="p">:</span> <span class="n">Invalid</span> <span class="n">argument</span><span class="p">:</span> <span class="n">expected</span> <span class="o">%</span><span class="n">d</span><span class="o">.%</span><span class="n">d</span><span class="p">,</span> <span class="o">%</span><span class="n">d</span><span class="o">.%</span><span class="n">d</span><span class="o">.%</span><span class="n">d</span><span class="p">,</span> <span class="ow">or</span> <span class="o">%</span><span class="n">d</span><span class="o">.%</span><span class="n">d</span><span class="o">.%</span><span class="n">d</span><span class="o">.%</span><span class="n">d</span> <span class="n">form</span> <span class="k">for</span> <span class="n">driver</span> <span class="n">version</span><span class="p">;</span> <span class="n">got</span> <span class="s2">&quot;1&quot;</span>
<span class="mi">2018</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">22</span> <span class="mo">04</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">12.431332</span><span class="p">:</span> <span class="n">I</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">stream_executor</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">cuda_diagnostics</span><span class="o">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">369</span><span class="p">]</span> <span class="n">driver</span> <span class="n">version</span> <span class="nb">file</span> <span class="n">contents</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;NVRM version: NVIDIA UNIX x86_64 Kernel Module  384.69  Wed Aug 16 19:34:54 PDT 2017</span>
<span class="s2">GCC version:  gcc version 4.8.5 20150623 (Red Hat 4.8.5-11) (GCC)</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="mi">2018</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">22</span> <span class="mo">04</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">12.431410</span><span class="p">:</span> <span class="n">I</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">stream_executor</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">cuda_diagnostics</span><span class="o">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">193</span><span class="p">]</span> <span class="n">kernel</span> <span class="n">reported</span> <span class="n">version</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">384.69</span><span class="o">.</span><span class="mi">0</span>
</pre></div>


<p>原因比较明确，就是没有发现显卡设备，解决的方式就是挂载显卡的设备：</p>
<div class="highlight"><pre><span></span>docker run --device /dev/nvidia0:/dev/nvidia0 --device /dev/nvidiactl:/dev/nvidiactl --device /dev/nvidia-uvm:/dev/nvidia-uvm -itd -v /sys/fs/cgroup:/sys/fs/cgroup {IMAGE-NAME}:{VERSION}
</pre></div>


<blockquote>
<p>注： 这个问题不会在k8s中出现，原因在于我们申请显卡资源的时候，k8s替我们做了上述工作。</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="n">resources</span><span class="o">:</span>
  <span class="n">limits</span><span class="o">:</span>
    <span class="n">alpha</span><span class="o">.</span><span class="na">kubernetes</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">nvidia</span><span class="o">-</span><span class="n">gpu</span><span class="o">:</span> <span class="mi">1</span>
</pre></div>


<blockquote>
<p>另外，nvidia官方提供的nvidia-docker也会帮我们挂载显卡设备。</p>
</blockquote>
<h2>参考文档</h2>
<p><a href="https://www.kubernetes.org.cn/1738.html">Harbor用户机制、镜像同步和与Kubernetes的集成实践</a> <br>
<a href="https://hub.docker.com/r/nvidia/cuda/">CUDA docker镜像</a> <br>
https://github.com/uber/horovod <br>
https://github.com/uber/horovod/blob/master/docs/gpus.md <br>
<a href="http://docs.nvidia.com/deeplearning/sdk/nccl-release-notes/overview.html">Nvidia nccl-release</a></p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://www.shushilvshe.com/tag/shen-du-xue-xi.html">深度学习</a>
      <a href="http://www.shushilvshe.com/tag/docker.html">docker</a>
      <a href="http://www.shushilvshe.com/tag/tensorflow.html">tensorflow</a>
      <a href="http://www.shushilvshe.com/tag/kubernetes.html">kubernetes</a>
    </p>
  </div>



    <div class="addthis_relatedposts_inline">


</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " shushilvshe's Blog ",
  "url" : "http://www.shushilvshe.com",
  "image": "http://www.shushilvshe.com/images/baya.jpg",
  "description": "shushilvshe's Thoughts and Writings"
}
</script>

</body>
</html>