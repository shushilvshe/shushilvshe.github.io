<!DOCTYPE html>
<html lang="zh_cn">
<head>
	<meta charset="utf-8">
	<title>tensorflow-gpu-docker镜像安装及部署文档 — shushilvshe's Blog</title>
	<meta name="description" content="Title: tensorflow-gpu-docker镜像安装及部署文档; Date: 2017-12-15; Author: ssls">
	<meta name="author" content="ssls">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="http://www.shushilvshe.com/theme/html5.js"></script>
		<![endif]-->
	<link href="http://www.shushilvshe.com/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="http://www.shushilvshe.com/theme/css/local.css" rel="stylesheet">
	<link href="http://www.shushilvshe.com/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="http://www.shushilvshe.com/">shushilvshe's Blog</a>
			<br><small>Data Developer</small></h1>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">tensorflow-gpu-docker镜像安装及部署文档</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">ssls</h4>
		</span>
		<time datetime="2017-12-15T18:01:03+08:00" itemprop="datePublished">2017-12-15(星期五) 18:01</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="http://www.shushilvshe.com/category/data.html" rel="category">Data</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="http://www.shushilvshe.com/tag/shen-du-xue-xi.html" rel="tag">深度学习</a>
		</span>
		<span itemprop="keywords">
			<a href="http://www.shushilvshe.com/tag/docker.html" rel="tag">docker</a>
		</span>
		<span itemprop="keywords">
			<a href="http://www.shushilvshe.com/tag/tensorflow.html" rel="tag">tensorflow</a>
		</span>
		<span itemprop="keywords">
			<a href="http://www.shushilvshe.com/tag/kubernetes.html" rel="tag">kubernetes</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p><link rel="stylesheet" href="http://yandex.st/highlightjs/6.2/styles/googlecode.min.css"></p>
<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>

<script src="http://yandex.st/highlightjs/6.2/highlight.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>

<script type="text/javascript">
 $(document).ready(function(){
      $("h2,h3,h4,h5,h6").each(function(i,item){
        var tag = $(item).get(0).localName;
        $(item).attr("id","wow"+i);
        $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
        $(".newh2").css("margin-left",0);
        $(".newh3").css("margin-left",20);
        $(".newh4").css("margin-left",40);
        $(".newh5").css("margin-left",60);
        $(".newh6").css("margin-left",80);
      });
 });
</script>

<div id="category"></div>

<h2>基本环境</h2>
<ul>
<li>tensorflow-gpu 1.4.1</li>
<li>cuda8</li>
<li>cudnn6</li>
<li>centos7</li>
<li>python 3.6.2</li>
<li>portainer 1.15.5 （轻量级docker集群管理平台）</li>
<li>harbor 1.1.2 （用于存储和分发Docker镜像的企业级Registry服务器）</li>
<li>kubernetes 1.8.3 (企业级容器集群管理系统)</li>
</ul>
<h2>前置条件</h2>
<ul>
<li>安装docker （docker-ce 17.09 版本）, 过程参照 <a href="http://www.shushilvshe.com/data/docker.html#wow8">[docker安装]</a></li>
<li>安装kubernetes 1.8.3，过程参照 <a href="http://blog.csdn.net/A632189007/article/details/78815807">[Docker Kubernetes1.8.3集群环境搭建（CentOS）]</a></li>
<li>安装portainer，过程参照 <a href="https://portainer.readthedocs.io/en/stable/deployment.html">[Deployment]</a></li>
<li>安装Harbor， 过程参照  <a href="http://blog.csdn.net/a632189007/article/details/78777224">[搭建docker私有仓库 -- Harbor]</a></li>
</ul>
<h2>制作tensorflow-gpu docker镜像</h2>
<h3>拉取并启动基础镜像—— <code>nvidia/cuda:8.0-cudnn6-runtime-centos7</code></h3>
<ul>
<li>
<p>获取nvidia/cuda镜像</p>
<div class="highlight"><pre><span></span>docker pull nvidia/cuda:8.0-cudnn6-runtime-centos7
</pre></div>


</li>
<li>
<p>运行nvidia/cuda镜像</p>
<div class="highlight"><pre><span></span>docker run -it -v /data:/host_data nvidia/cuda:8.0-cudnn6-runtime-centos7 /bin/bash
</pre></div>


</li>
</ul>
<h3>编译安装python 3.6.2， 过程参照 <a href="http://www.shushilvshe.com/data/dl-env-build.html#wow8">[python编译安装]</a></h3>
<h3>安装tensorflow-gpu 1.4.1</h3>
<div class="highlight"><pre><span></span>pip3 install -U scikit-image -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install -U h5py -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install -U scipy -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install -U imageio -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install -U tensorflow-gpu==1.4.1 -i https://pypi.tuna.tsinghua.edu.cn/simple
</pre></div>


<h3>将新环境打成新镜像包</h3>
<h4>查询当前 CONTAINER ID</h4>
<div class="highlight"><pre><span></span>[root@gpu187 ~]# docker ps 
CONTAINER ID        IMAGE                                                        COMMAND                  CREATED             STATUS              PORTS               NAMES
4e5918306494        192.168.1.184:5000/nvidia/cuda:8.0-cudnn6-runtime-centos7   &quot;/bin/bash&quot;              4 minutes ago       Up 4 minutes                            ecstatic_saha
</pre></div>


<h4>保存新镜像</h4>
<div class="highlight"><pre><span></span>docker commit 4e5918306494 tensorflow-gpu-1.4.1-py36:1.0.0
</pre></div>


<h4>上传镜像到本地仓库</h4>
<p>打开portainer管理界面， 在左侧边框选择 endpoint-&gt; images，右侧会显示出刚保存的新镜像</p>
<p><center><img src="https://i.imgur.com/AEUZyjh.jpg" width="1440"/></center></p>
<p>点击镜像id进去，在右侧界面选择仓库，输入tag name，点击Tag就可以在界面上方生成一个新tag（PS：示意图为之前打好的tag，所以上方只有一个tag，仅做说明界面用），点击 “上箭头” 符号，一两分钟后便可以上传到本地镜像仓库中。</p>
<p><center><img src="https://i.imgur.com/Ni9qW6H.jpg" width="1440"/></center></p>
<p><center><img src="https://i.imgur.com/tJqdDMC.jpg" width="1440"/></center></p>
<h2>部署镜像并启动训练模型任务</h2>
<h3>使用 portainer 单点部署</h3>
<p>进入portainer管理界面，左侧选择Containers，右侧点击Add container</p>
<p><center><img src="https://i.imgur.com/7QbxZAF.jpg" width="1440"/></center></p>
<p>填入容器名称，选择镜像，在Command一栏输入需要执行的脚本，还有工作目录。</p>
<p><center><img src="https://i.imgur.com/VpbK8qG.jpg" width="1440"/></center></p>
<p>挂载本地Volumn，（主要是nvidia cuda库）</p>
<p><center><img src="https://i.imgur.com/o9mw2Wt.jpg" width="1440"/></center></p>
<p>在Env中配置显卡id， <code>CUDA_VISIABLE_DEVIDE</code>为0，使用第一块儿显卡</p>
<p><center><img src="https://i.imgur.com/sQgGZSv.jpg" width="1440"/></center></p>
<p>启用特权权限，点击部署容器就可以了。（PS:启动之后，可以从容器界面看启动的状态）</p>
<p><center><img src="https://i.imgur.com/VzRvThe.jpg" width="1440"/></center></p>
<h3>使用 Kubernetes 自动集群部署</h3>
<p>在Kubernetes dashboard中，点击右上角添加，选择上传yaml文件，选择本地yaml文件后，点击上传就可以了（相当于运行 <code>kubectl  create -f xxx.yaml</code>）</p>
<p><center><img src="https://i.imgur.com/23GxwRM.jpg" width="1440"/></center></p>
<ul>
<li>yaml配置文件示例<div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">extensions</span><span class="sr">/v1beta1    # Deployment 对应的是 extensions/</span><span class="n">v1beta1</span> <span class="err">版本</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span> 
  <span class="n">labels</span><span class="o">:</span>  
    <span class="n">app</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>  
  <span class="n">name</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>  
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">bigdata</span>
<span class="n">spec</span><span class="o">:</span>  
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">1</span>  
  <span class="n">selector</span><span class="o">:</span>  
    <span class="n">matchLabels</span><span class="o">:</span>  
      <span class="n">app</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>
  <span class="n">template</span><span class="o">:</span>  
    <span class="n">metadata</span><span class="o">:</span>  
      <span class="n">labels</span><span class="o">:</span>  
        <span class="n">app</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span> 
    <span class="n">spec</span><span class="o">:</span>  
      <span class="n">containers</span><span class="o">:</span> 
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span> 
        <span class="n">image</span><span class="o">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.184</span><span class="o">:</span><span class="mi">5000</span><span class="sr">/bigdata/</span><span class="n">tensorflow</span><span class="o">-</span><span class="n">gpu</span><span class="o">-</span><span class="n">py2</span><span class="o">:</span><span class="mf">1.3</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">gpu</span>
        <span class="n">workingDir</span><span class="o">:</span> <span class="sr">/ceph/docker/katong_2_lemiao/</span>
        <span class="n">resources</span><span class="o">:</span> 
          <span class="n">limits</span><span class="o">:</span> 
            <span class="n">alpha</span><span class="o">.</span><span class="na">kubernetes</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">nvidia</span><span class="o">-</span><span class="n">gpu</span><span class="o">:</span> <span class="mi">1</span>   
        <span class="err">#</span> <span class="n">env</span><span class="o">:</span>
        <span class="err">#</span> <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">CUDA_VISIBLE_DEVICES</span>
        <span class="err">#</span>   <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;0&quot;</span>   <span class="err">#</span><span class="n">kubernetes</span> <span class="mf">1.5</span><span class="o">.</span><span class="mi">2</span><span class="err">版本只能识别一台机器中的一张显卡</span>
        <span class="n">command</span><span class="o">:</span> 
        <span class="o">-</span> <span class="o">./</span><span class="n">run</span><span class="o">.</span><span class="na">sh</span>
        <span class="n">ports</span><span class="o">:</span>  
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">8088</span>  
          <span class="n">protocol</span><span class="o">:</span> <span class="n">TCP</span>  
        <span class="err">#</span><span class="n">livenessProbe</span><span class="o">:</span>  
        <span class="err">#</span>  <span class="n">httpGet</span><span class="o">:</span>  
        <span class="err">#</span>    <span class="n">path</span><span class="o">:</span> <span class="o">/</span>  
        <span class="err">#</span>    <span class="n">port</span><span class="o">:</span> <span class="mi">8088</span>  
        <span class="err">#</span>  <span class="n">initialDelaySeconds</span><span class="o">:</span> <span class="mi">30</span>
        <span class="err">#</span>  <span class="n">timeoutSeconds</span><span class="o">:</span> <span class="mi">30</span> 
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/ceph/</span><span class="n">docker</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">zi</span><span class="o">-</span><span class="n">data</span>
        <span class="o">-</span> <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/usr/local/</span><span class="n">nvidia</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">nvidia</span><span class="o">-</span><span class="n">driver</span>
        <span class="o">-</span> <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/sys/fs/</span><span class="n">cgroup</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">cgroup</span>
      <span class="err">#</span> <span class="n">nodeName</span><span class="o">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.186</span>      <span class="err">#</span>
      <span class="n">volumes</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">hostPath</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="sr">/ceph/</span><span class="n">docker</span>
        <span class="n">name</span><span class="o">:</span> <span class="n">zi</span><span class="o">-</span><span class="n">data</span>
      <span class="o">-</span> <span class="n">hostPath</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="sr">/var/lib/nvidia-docker/volumes/nvidia_driver/</span><span class="mf">384.69</span>
        <span class="n">name</span><span class="o">:</span> <span class="n">nvidia</span><span class="o">-</span><span class="n">driver</span>
      <span class="o">-</span> <span class="n">hostPath</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="sr">/sys/fs/</span><span class="n">cgroup</span>
        <span class="n">name</span><span class="o">:</span> <span class="n">cgroup</span>

<span class="o">---</span>  
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>  
<span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>  
<span class="n">metadata</span><span class="o">:</span>  
  <span class="n">labels</span><span class="o">:</span>  
    <span class="n">app</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>  
  <span class="n">name</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>  
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">bigdata</span>
<span class="n">spec</span><span class="o">:</span>  
  <span class="n">type</span><span class="o">:</span> <span class="n">NodePort</span>  
  <span class="n">ports</span><span class="o">:</span> 
  <span class="o">-</span> <span class="n">port</span><span class="o">:</span> <span class="mi">8088</span>  
    <span class="n">targetPort</span><span class="o">:</span> <span class="mi">8088</span> 
    <span class="n">nodePort</span><span class="o">:</span> <span class="mi">30009</span>
  <span class="n">selector</span><span class="o">:</span>  
    <span class="n">app</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">py2</span>
</pre></div>


</li>
</ul>
<h2>参考</h2>
<p><a href="https://www.kubernetes.org.cn/1738.html">Harbor用户机制、镜像同步和与Kubernetes的集成实践</a></p>
<p><a href="https://hub.docker.com/r/nvidia/cuda/">CUDA docker镜像</a></p></div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://www.shushilvshe.com">shushilvshe's Blog</a></li>
							<li><a href="http://www.shushilvshe.com//category/data.html"><i class="fa fa-Data "></i> Data</a></li>
							<li><a href="http://www.shushilvshe.com//category/food.html"><i class="fa fa-Food "></i> Food</a></li>
							<li><a href="http://www.shushilvshe.com//category/travel.html"><i class="fa fa-Travel "></i> Travel</a></li>
							<li><a href="http://www.shushilvshe.com//"><i class="fa fa-Photo "></i> Photo</a></li>
							<li><a href="http://www.shushilvshe.com/pages/about.html"><i class="fa fa-About ME "></i> About ME</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://www.shushilvshe.com/category/data.html">Data (22)</a></li>
							<li><a href="http://www.shushilvshe.com/category/food.html">food (1)</a></li>
							<li><a href="http://www.shushilvshe.com/category/travel.html">travel (11)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="/categories.html">Category</a></li>
							<li><a href="/tags.html">Tags</a></li>
							<li><a href="/archives.html">Archives</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; ssls 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>