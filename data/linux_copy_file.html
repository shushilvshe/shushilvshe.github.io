
<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/font-awesome/css/font-awesome.min.css">




    <link rel="shortcut icon" href="http://www.shushilvshe.com/images/lvcheng.jpg" type="image/x-icon">
    <link rel="icon" href="http://www.shushilvshe.com/images/lvcheng.jpg" type="image/x-icon">



<meta name="author" content="ssls" />
<meta name="description" content="linux主机之间快速高效的拷贝大数据文件" />
<meta name="keywords" content="linux">

<meta property="og:site_name" content="shushilvshe's Blog"/>
<meta property="og:title" content="linux主机之间快速高效的拷贝大数据文件"/>
<meta property="og:description" content="linux主机之间快速高效的拷贝大数据文件"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://www.shushilvshe.com/data/linux_copy_file.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-06-06 11:46:24+08:00"/>
<meta property="article:modified_time" content="2018-06-06 11:46:29+08:00"/>
<meta property="article:author" content="http://www.shushilvshe.com/author/ssls.html">
<meta property="article:section" content="Data"/>
<meta property="article:tag" content="linux"/>
<meta property="og:image" content="http://www.shushilvshe.com/images/self.jpg">

  <title>shushilvshe's Blog &ndash; linux主机之间快速高效的拷贝大数据文件</title>

</head>
<body>

  <aside>
    <div>
      <a href="http://www.shushilvshe.com">
        <img src="http://www.shushilvshe.com/images/self.jpg" alt="数食旅摄" title="数食旅摄">
      </a>
      <h1><a href="http://www.shushilvshe.com">数食旅摄</a></h1>

<p>Data Developer</p>
      <nav>
        <ul class="list">
          <li><a href="http://www.shushilvshe.com/pages/about.html#about">About ME</a></li>

          <li><a href="/categories.html" target="_blank">Category</a></li>
          <li><a href="/tags.html" target="_blank">Tags</a></li>
          <li><a href="/archives.html" target="_blank">Archives</a></li>
        </ul>
      </nav>

      <ul class="social">
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="http://www.shushilvshe.com">    Home
</a>

      <a href="/category/data.html">Data</a>
      <a href="/category/food.html">Food</a>
      <a href="/category/travel.html">Travel</a>
      <a href="/category/photo.html">Photo</a>
      <a href="/category/bytalk.html">ByTalk</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="data/linux_copy_file">linux主机之间快速高效的拷贝大数据文件</h1>
    <p>
          Posted on 2018-06-06(星期三) 11:46 in <a href="http://www.shushilvshe.com/category/data.html">Data</a>


    </p>
  </header>


  <div>
    <h2>linux主机之间快速高效的拷贝大数据文件</h2>
<p>以前我们跨主机拷贝大数据的时候，基本思路就是:</p>
<ul>
<li>在源端打包压缩为tar.gz文件</li>
<li>采用scp或rsync等方式拷贝到目标主机|或者在目标机wget下载</li>
<li>在目标主机解压文件</li>
</ul>
<p>这三个过程是同步阻塞，即不能同时异步执行，导致效率低下。
现在我们将过程优化为以数据流的方式，同时执行（非阻塞模式），则效率一般可以提高到原来的3倍以上，具体实现如下：</p>
<div class="highlight"><pre><span></span>磁盘读取----&gt;打包----&gt;压缩------&gt;传输----&gt;解压缩--&gt;拆包----&gt;落盘
       |-&gt;tar  |-&gt;gzip   |-&gt;ssh   |-&gt;gzip |-&gt;tar
</pre></div>


<p>比如我要将本地的test目录拷贝到“目标IP”的的data目录，则命令如下：</p>
<div class="highlight"><pre><span></span>tar -c test/ |pigz |ssh -c root 目标IP &quot;gzip -d|tar -xC /data&quot;
</pre></div>


<p>当然，这里的解压过程仍然用了效率比较低下的gzip，如果将解压工具换成lz4（但需要单独编译安装），则效率可以再提高不少。
如果不需要解压，则命令变为：</p>
<div class="highlight"><pre><span></span>tar -c test/ |pigz |ssh -c root 目标IP &quot;cat &gt;/data/test.tar.gz&quot;
</pre></div>


<p>注：因为采用了流式压缩，解压过程必须加上-i参数，及 <code>tar –ixf /data/test.tar.gz</code></p>
<p>说明： pigz是一个高效的压缩工具，可以将多核CPU的每一分剩余性能都用来做压缩计算。而传统的gzip则只能用单核CPU。比如一台2个8 core cpu服务器采用pigz和gzip压缩相同的数据，一般性能差距至少在7-8倍以上（一般不会达到理论的16倍，因为受限于磁盘的读写速度和内存等资源）。</p>
<h3>另外：如果同步的是大量的小文件，可通过多进程的方式</h3>
<ul>
<li>
<p>1、使用 <code>parallel</code></p>
<div class="highlight"><pre><span></span>ls /ssd_1/face/datasets/test | parallel -v -j10 rsync -raz --progress {} 192.168.1.190:/ssd_1/face/datasets/test/{}
</pre></div>


</li>
<li>
<p>2、使用 <code>xargs</code></p>
<div class="highlight"><pre><span></span>ls -1 /main/files | xargs -I {} -P 5 -n 1 rsync -avh /main/files/{} /main/filesTest/
</pre></div>


</li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://www.shushilvshe.com/tag/linux.html">linux</a>
    </p>
  </div>



    <div class="addthis_relatedposts_inline">


</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " shushilvshe's Blog ",
  "url" : "http://www.shushilvshe.com",
  "image": "http://www.shushilvshe.com/images/self.jpg",
  "description": "shushilvshe's Thoughts and Writings"
}
</script>

</body>
</html>