<!DOCTYPE html>
<html>
    <head>
        <title>制作ssh互信的docker镜像 - shushilvshe's Blog</title>
        <meta charset="utf-8" />
        <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" />
        <link href="http://www.shushilvshe.com/theme/static/css/style.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    </head>

    <body id="index" class="archive">
        <div class="container">
            <div class="header">
                <ul class="nav nav-pills pull-right">
                    <li class=""><a href="http://www.shushilvshe.com">Home</a></li>
                    <li><a href="http://www.shushilvshe.com/pages/about.html">About ME</a></li>
                    <li><a href="http://www.shushilvshe.com/archives.html">Archives</a></li>
                </ul>
                <h3 class="text-muted"><a href="http://www.shushilvshe.com">shushilvshe's Blog</a></h3>
				<h2 class="text-muted">Data Developer</h2>
             </div>
<section id="content" class="article content">
  <header>
    <h2 class="entry-title">
      <a href="http://www.shushilvshe.com/data/docker-ssh.html" rel="bookmark"
         title="Permalink to 制作ssh互信的docker镜像">制作ssh互信的docker镜像</a></h2>
 
  </header>
  
     
  <div class="entry-content">
    <p>基于nvidia/cuda的镜像（nvidia/cuda:8.0-cudnn6-runtime-centos7）生成了一个的tensorflow-gpu 1.4.1编译版本的镜像，通过kubernetes（1.8.3）容器编排工具进行容器间的管理。现有六个节点，一台部署kubernetes，无GPU，还有一个节点有4块GPU，余下四个节点均有一块GPU，所有的GPU均为NVIDIA Gefore 1080Ti。为提高工作工程中试错效率，需要将GPU集群资源合理的利用起来，也即需要自动调度和并发使用GPU。经研究，opmpi + nccl（nvidia的）可以实现，但mpi需要集群间的各容器是互信的，但实际运行的环境中所有容器均来源于同一镜像，所以目的就是达到能免密登陆自己就可以了（其实免密登陆本机和登陆别的机器操作基本一样）</p>
<p>首先，要用docker启用一个container</p>
<div class="highlight"><pre><span></span>sudo docker run -it nvidia/cuda:8.0-cudnn6-runtime-centos7
</pre></div>


<p>既然要使用ssh，那么我们肯定要安装ssh。 </p>
<div class="highlight"><pre><span></span>sudo yum -y install openssh-server openssh-clients
</pre></div>


<p>然后，生成公私钥 </p>
<div class="highlight"><pre><span></span>sshkey-gen -t rsa
</pre></div>


<p>然后回车，回车，回车，复制一份公钥生成 authorized_keys（PS： authorized_keys文件权限和id_dsa.pub一致即可）。</p>
<div class="highlight"><pre><span></span>cp /root/.ssh/id_dsa.pub /root/.ssh/authorized_keys
</pre></div>


<p>修改配置 <code>/etc/ssh/ssh_config</code>， 去除第一次ssh远程登录时fingerprint指纹添加过程（第一次远程ssh主机时提示输入yes/no的过程）：</p>
<div class="highlight"><pre><span></span>Host *
   StrictHostKeyChecking no
   UserKnownHostsFile=/dev/null
</pre></div>


<p>然后，使用 <code>docker ps</code> 查看containerId，然后用 <code>container commit CONTAINER</code> 命令生成一个新镜像。 </p>
<div class="highlight"><pre><span></span>sudo docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]
</pre></div>
  </div><!-- /.entry-content -->
   <footer class="post-info text-muted">
    Posted on <abbr class="published" title="2018-01-04T18:09:06+08:00">
      2018-01-04(星期四) 18:09
    </abbr>
    <address class="vcard author">
      by <a class="url fn" href="http://www.shushilvshe.com/author/ssls.html">ssls</a>
    </address> in <a href="http://www.shushilvshe.com/category/data.html">Data</a> Tagged <a href="http://www.shushilvshe.com/tag/shen-du-xue-xi.html">深度学习 </a><a href="http://www.shushilvshe.com/tag/ssh.html">ssh </a><a href="http://www.shushilvshe.com/tag/docker.html">docker </a>  </footer><!-- /.post-info -->
</section>
            <footer id="contentinfo" class="footer">
                    <nav class="pull-right bottom-nav">
                        <a href="http://www.shushilvshe.com/None">RSS</a>
                    </nav>
                    <address id="about" class="vcard body">
                    &copy; <a href="http://www.shushilvshe.com">shushilvshe's Blog</a> Proudly powered by <a href="http://getpelican.com/">Pelican</a>
                    </address><!-- /#about -->
            </footer><!-- /#contentinfo -->
        </div><!-- container -->
    </body>
</html>