<!doctype html>
<html class="no-js" lang="en">
    <head>
        <link rel="shortcut icon" href="http://www.shushilvshe.com/images/lvcheng.jpg" />

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="ssls" />
        <title>CDH升级（5.11.0 -> 5.12.0）</title>
        
<meta name="description" content="&lt;p&gt;CDH升级（5.11.0 -&amp;gt; 5.12.0）, 大版本升级，CM和CDH详细更新过程。  版本升级更新特性参考： https://www.cloudera.com/documentation/enterprise/release-notes/topics/cdh_rn_new_in_cdh_512.html#cdh_rn_new_in_cdh_512&lt;/p&gt;" />
<meta name="keywords" content=" 大数据 CDH bigdata  "/>

        <!--[if !IE 7]>
        <style type="text/css">
            #main-content {display:table;height:100%}
        </style>
        <![endif]-->
        <link rel="stylesheet" href="http://www.shushilvshe.com/theme/css/backdrop.css" />
        <link rel="stylesheet" href="http://www.shushilvshe.com/theme/css/pygments.css" />
        <script src="http://www.shushilvshe.com/theme/js/modernizr.js"></script>


    </head>
      

    <body>
        <div class="master-row">

            <div class="content-pane main-content">
                <nav class="top-bar" data-topbar role="navigation">
                    <ul class="title-area">
                        <li class="name"><!-- Leave this empty --></li>
                        <li class="toggle-topbar menu-icon"><a href="#"><span></span></a></li>
                    </ul>
                    <section class="top-bar-section">
                        <ul class="left">
                            <li><a href="http://www.shushilvshe.com/pages/about.html">About ME</a></li>
                        </ul>
                        <ul class="right">
                            <li class="active"><a href="http://www.shushilvshe.com/category/data.html">Data</a></li>
                            <li><a href="http://www.shushilvshe.com/category/food.html">food</a></li>
                            <li><a href="http://www.shushilvshe.com/category/travel.html">travel</a></li>
                        </ul>
                    </section>
                </nav>

                <div class="row title-bar">
                    <div class="small-12 columns">
                        <h1><a href="http://www.shushilvshe.com">shushilvshe's Blog</a></h1><h2> <small>Data Developer</small></h2>
                        <hr>
                    </div>
                </div>
            
                <div id="contents">
<div class="row">
    <div class="small-12 columns article">
        <h2>CDH升级（5.11.0 -> 5.12.0）</h2>
        <div class="row info-bar" style="margin-left:0rem;margin-bottom:6px;">
    <div class="small-12 columns">
        <ul class="inline-list">
            <li><span><i class="fa fa-calendar"></i>&nbsp; 2017-07-24(星期一) 21:46</span></li>
            <li><span><i class="fa fa-folder-open"></i>&nbsp; <a href="http://www.shushilvshe.com/category/data.html">Data</a></span></li>
            <li>
                <span>
                    <i class="fa fa-tags"></i>&nbsp;
                    <a href="http://www.shushilvshe.com/tag/da-shu-ju.html"><span class="label">大数据</span></a>
                    <a href="http://www.shushilvshe.com/tag/cdh.html"><span class="label">CDH</span></a>
                    <a href="http://www.shushilvshe.com/tag/bigdata.html"><span class="label">bigdata</span></a>
                </span>
            </li>
        </ul>
    </div>
</div>
        <section class="article">
            <h3>集群环境</h3>
<table>
    <tr>
        <td>mimo41</td>
        <td>mimo42</td>
        <td>mimo56</td>
    </tr>
</table>

<p><strong>mimo41为主节点</strong></p>
<h3>1.CM升级</h3>
<ul>
<li>下载cm安装包： <code>cloudera-manager-centos7-cm5.12.0_x86_64.tar.gz</code></li>
</ul>
<blockquote>
<p>当前版本下载地址：<code>https://archive.cloudera.com/cm5/cm/5/cloudera-manager-centos7-cm5.12.0_x86_64.tar.gz</code></p>
<p>所有版本下载地址：<code>https://www.cloudera.com/documentation/enterprise/release-notes/topics/cm_vd.html</code></p>
</blockquote>
<ul>
<li>
<p><strong>解压安装包</strong></p>
<div class="highlight"><pre><span></span>[root@mimo41 ~]# tar -zxvf cloudera-manager-centos7-cm5.12.0\_x86\_64.tar.gz
</pre></div>


<p>解压得两个文件夹 <code>cm-5.12.0</code> 和 <code>cloudera</code>, 后者不需要修改， 当前需要所有核心的东西都在这，此时我们只需要更新<code>cm-5.12.0</code>，</p>
<div class="highlight"><pre><span></span>[root@mimo41 ~]# cd /root/cm-5.12.0/etc/cloudera-scm-agent
[root@mimo41 cloudera-scm-agent]# vim config.ini
</pre></div>


<p>修改<code>server_host</code>和<code>server_port</code>两个属性值，此处端口使用的默认端口，只需要修改<strong><code>server_host=mimo41</code></strong>即可,将目录移到<strong><code>/opt</code></strong>下</p>
<div class="highlight"><pre><span></span>[root@mimo41 ~]# mv cm-5.12.0/ /opt
</pre></div>


<p>将<code>cm-5.12.0</code> 拷贝到集群的其他两台机器上</p>
<div class="highlight"><pre><span></span>[root@mimo41 opt]# scp -r cm-5.12.0/ mimo42:/opt/
[root@mimo41 opt]# scp -r cm-5.12.0/ mimo56:/opt/
</pre></div>


</li>
<li>
<p><strong>基本工作准备完毕，下一步需要将老集群CM的配置信息同步到新集群CM,两部分信息需要同步：</strong></p>
<ul>
<li>
<p><strong>server的数据库信息</strong></p>
<p>覆盖默认的<code>db.properties</code>文件</p>
<div class="highlight"><pre><span></span>[root@mimo41 opt]# cp ./cm-5.11.0/etc/cloudera-scm-server/db.properties ./cm-5.12.0/etc/cloudera-scm-server/
</pre></div>


</li>
<li>
<p><strong>agent的uuid信息</strong></p>
<p>拷贝 <strong><code>uuid</code></strong> 和 <strong><code>cm_guid</code></strong>(cm_guid文件还不确定作用) 文件</p>
<div class="highlight"><pre><span></span>[root@mimo41 opt]# cp /opt/cm-5.11.0/lib/cloudera-scm-agent/*uid /opt/cm-5.12.0/lib/cloudera-scm-agent
[root@mimo42 opt]# cp /opt/cm-5.11.0/lib/cloudera-scm-agent/*uid /opt/cm-5.12.0/lib/cloudera-scm-agent
[root@mimo56 opt]# cp /opt/cm-5.11.0/lib/cloudera-scm-agent/*uid /opt/cm-5.12.0/lib/cloudera-scm-agent
</pre></div>


</li>
</ul>
</li>
<li>
<p><strong>关闭集群服务和CM的server和agent服务</strong></p>
<ul>
<li>
<p><strong>通过cm界面关闭集群服务和CM服务</strong></p>
<div class="highlight"><pre><span></span>[root@mimo41 init.d]# /opt/cm-5.11.0/etc/init.d/cloudera-scm-server stop
[root@mimo41 init.d]# /opt/cm-5.11.0/etc/init.d/cloudera-scm-agent stop
[root@mimo42 init.d]# /opt/cm-5.11.0/etc/init.d/cloudera-scm-agent stop
[root@mimo56 init.d]# /opt/cm-5.11.0/etc/init.d/cloudera-scm-agent stop
</pre></div>


<p><strong>验证服务都已经正常关闭</strong></p>
<div class="highlight"><pre><span></span>ps -ef | grep cloudera-scm-server | grep -v grep
ps -ef | grep cloudera-scm-agent | grep -v grep
</pre></div>


</li>
<li>
<p><strong>unmount进程挂载点</strong>
    <center><img alt="" src="http://i.imgur.com/R2PhkAs.png"></center></p>
<div class="highlight"><pre><span></span>[root@mimo41 init.d]# umount /opt/cm-5.11.0/run/cloudera-scm-agent/process
[root@mimo42 init.d]# umount /opt/cm-5.11.0/run/cloudera-scm-agent/process
[root@mimo56 init.d]# umount /opt/cm-5.11.0/run/cloudera-scm-agent/process
</pre></div>


</li>
<li>
<p><strong>通过新版本CM启动server和agent服务</strong></p>
<div class="highlight"><pre><span></span>[root@mimo41 ~]# /opt/cm-5.12.0/etc/init.d/cloudera-scm-server start
[root@mimo41 ~]# /opt/cm-5.12.0/etc/init.d/cloudera-scm-agent start
[root@mimo42 ~]# /opt/cm-5.12.0/etc/init.d/cloudera-scm-agent start
[root@mimo56 ~]# /opt/cm-5.12.0/etc/init.d/cloudera-scm-agent start
</pre></div>


</li>
<li>
<p><strong>打开CM管理网址，登录进去</strong></p>
<p>网页右上角，点击<code>关于</code>，显示 <code>5.12.0</code>版本 ，表示CM升级成功 
    <center><img alt="" src="http://i.imgur.com/6UP96pg.png"><img alt="" src="http://i.imgur.com/bMQti97.png"></center></p>
</li>
</ul>
</li>
</ul>
<h3>2.CDH升级</h3>
<ul>
<li><strong>准备工作（如果网速不是特别好的话，提前下载好Parcel文件，放到 <code>/opt/cloudera/parcel-repo</code> 目录下），下载方式：</strong></li>
</ul>
<p><center><img alt="" src="http://i.imgur.com/ZiPNmwo.png"></center></p>
<p><center><img alt="" src="http://i.imgur.com/RHUBLt1.png"></center></p>
<hr>
<p><strong>具体安装步骤如下：</strong></p>
<p><center><img alt="" src="http://i.imgur.com/uEBXrzA.png"></center></p>
<hr>
<p><strong>本次升级由于集群中没什么数据，所以就没备份数据库，强烈建议在生产环境中一定要备份数据库，要不然出问题就SB了，备份数据库步骤请参考附录</strong>
<center><img alt="" src="http://i.imgur.com/SgnM1cV.png"></center></p>
<hr>
<p><center><img alt="" src="http://i.imgur.com/0IVEu4e.png"></center></p>
<hr>
<p><center><img alt="" src="http://i.imgur.com/qP9tHkb.png"></center></p>
<hr>
<p><center><img alt="" src="http://i.imgur.com/grq4HwQ.png"></center></p>
<hr>
<p><center><img alt="" src="http://i.imgur.com/yEPQXip.png"></center></p>
<hr>
<p><center><img alt="" src="http://i.imgur.com/66Inshb.png"></center></p>
<hr>
<p><center><img alt="" src="http://i.imgur.com/cshvPfu.png"></center></p>
<hr>
<p><strong>升级集群的时候发生错误，查看日志，原来是原来HDFS上已经有 <code>spark-assembly.jar</code>，删除之</strong> </p>
<div class="highlight"><pre><span></span>[root@mimo41 parcel-repo]# sudo -u spark hadoop fs -rm -f /user/spark/location/spark-assembly.jar
</pre></div>


<p><center><img alt="" src="http://i.imgur.com/Yy19uBD.png"></center></p>
<hr>
<p><strong>后面一路绿灯</strong>
<center><img alt="" src="http://i.imgur.com/Sx1kt1d.png"></center></p>
<hr>
<p><center><img alt="" src="http://i.imgur.com/SZFUOTI.png"></center></p>
<hr>
<p><center><img alt="" src="http://i.imgur.com/ymUUk80.png"></center></p>
<p><strong>最后在CM管理界面启动服务，至此，CDH升级完毕。</strong></p>
<hr>
<h2>附录：</h2>
<p><strong>CM升级(官网)</strong></p>
<blockquote>
<p><code>https://www.cloudera.com/documentation/enterprise/5-10-x/topics/cm_ag_ug_cm5_tarballs.html</code></p>
</blockquote>
<p><strong>CDH升级(官网)</strong></p>
<blockquote>
<p><code>https://www.cloudera.com/documentation/enterprise/5-10-x/topics/install_upgrade_to_cdh5x_parcels.html</code></p>
</blockquote>
<p><strong>mysql数据库备份：</strong></p>
<blockquote>
<p><code>https://www.cloudera.com/documentation/enterprise/5-10-x/topics/cm_ag_backup_dbs.html#concept_tyh_rmq_bl</code></p>
</blockquote>    
        </section>
    </div>
</div>
                </div>

                <footer class="show-for-large-up">
<div class="row">
    <div class="small-6 medium-3 columns">
        <ul class="left-nav">
            <li><a href="http://www.shushilvshe.com">Home &nbsp;<i class="fa fa-home fa-fw"></i></a></li>
            <li><a href="http://www.shushilvshe.com/categories.html">Categories &nbsp;<i class="fa fa-folder-open fa-fw"></i></a></li>
        </ul>
    </div>
    <div class="small-6 medium-3 medium-push-6 columns">
        <ul class="right-nav">
            <li><a href="http://www.shushilvshe.com/archives.html"><i class="fa fa-archive fa-fw"></i>&nbsp; Archives</a></li>
        </ul>
    </div>
    <div class="small-12 medium-6 medium-pull-3 columns text-center">
        <p class="tag-cloud">
            <a href="http://www.shushilvshe.com/tags.html"><i class="fa fa-tags"></i>&nbsp;Tags:</a>&nbsp;&nbsp;
            &nbsp;&hellip;
        </p>
    </div>
    <div class="small-12 columns sub-footer">
        <hr>
        <div class="small-12 medium-6 columns">
            <p class="small-text-center medium-text-left">
                &copy;  ssls 
                <!-- <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="cc.png" /></a>-->
            </p>
        </div>
        <div class="small-12 medium-6 columns">
            <p class="small-text-center medium-text-right">
                Proudly powered by <a href="http://blog.getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="https://www.python.org/">Python</a>.
            </p>
        </div>
    </div>
</div>                </footer>
            </div>
            
            <div class="image-pane main-content" style="background: url(''); background-size:cover; background-position: right;">
                <div class="row">
                    <div class="small-12 medium-4 large-12 columns">
                    </div>

                    <div class="small-12 medium-4  large-12 columns link-list">
                        <h5 class='text-center'>Links</h5>
                        <ul class="inline-center">
                            <li><a href="/categories.html">Category</a></li>
                            <li><a href="/tags.html">Tags</a></li>
                            <li><a href="/archives.html">Archives</a></li>
                        </ul>
                    </div>

<!--
                    <div class="small-12 medium-3 large-12 columns">
                    </div>
-->
               </div>
            </div>
        </div>
        
        
        <div class="row">
            <footer class="hide-for-large-up">
<div class="row">
    <div class="small-6 medium-3 columns">
        <ul class="left-nav">
            <li><a href="http://www.shushilvshe.com">Home &nbsp;<i class="fa fa-home fa-fw"></i></a></li>
            <li><a href="http://www.shushilvshe.com/categories.html">Categories &nbsp;<i class="fa fa-folder-open fa-fw"></i></a></li>
        </ul>
    </div>
    <div class="small-6 medium-3 medium-push-6 columns">
        <ul class="right-nav">
            <li><a href="http://www.shushilvshe.com/archives.html"><i class="fa fa-archive fa-fw"></i>&nbsp; Archives</a></li>
        </ul>
    </div>
    <div class="small-12 medium-6 medium-pull-3 columns text-center">
        <p class="tag-cloud">
            <a href="http://www.shushilvshe.com/tags.html"><i class="fa fa-tags"></i>&nbsp;Tags:</a>&nbsp;&nbsp;
            &nbsp;&hellip;
        </p>
    </div>
    <div class="small-12 columns sub-footer">
        <hr>
        <div class="small-12 medium-6 columns">
            <p class="small-text-center medium-text-left">
                &copy;  ssls 
                <!-- <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="cc.png" /></a>-->
            </p>
        </div>
        <div class="small-12 medium-6 columns">
            <p class="small-text-center medium-text-right">
                Proudly powered by <a href="http://blog.getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="https://www.python.org/">Python</a>.
            </p>
        </div>
    </div>
</div>            </footer>
        </div>
        
        
        <script src="http://www.shushilvshe.com/theme/js/jquery.min.js"></script>
        <script src="http://www.shushilvshe.com/theme/js/foundation.min.js"></script>
        <script src="http://www.shushilvshe.com/theme/js/app.js"></script>
    </body>
  
</html>