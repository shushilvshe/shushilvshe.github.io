
<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="http://www.shushilvshe.com/theme/font-awesome/css/font-awesome.min.css">




    <link rel="shortcut icon" href="http://www.shushilvshe.com/images/lvcheng.jpg" type="image/x-icon">
    <link rel="icon" href="http://www.shushilvshe.com/images/lvcheng.jpg" type="image/x-icon">



<meta name="author" content="ssls" />
<meta name="description" content="peewee是一款轻量级、丰富的ORM（Object Relation Mapping，对象关系映射），支持 postgresql、mysql 和 sqlite。" />
<meta name="keywords" content="python, ORM">

<meta property="og:site_name" content="shushilvshe's Blog"/>
<meta property="og:title" content="peewee 入门教程"/>
<meta property="og:description" content="peewee是一款轻量级、丰富的ORM（Object Relation Mapping，对象关系映射），支持 postgresql、mysql 和 sqlite。"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://www.shushilvshe.com/python/peewee.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-08-31 20:04:38+08:00"/>
<meta property="article:modified_time" content="2017-08-31 20:04:41+08:00"/>
<meta property="article:author" content="http://www.shushilvshe.com/author/ssls.html">
<meta property="article:section" content="Data"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="ORM"/>
<meta property="og:image" content="http://www.shushilvshe.com/images/self.jpg">

  <title>shushilvshe's Blog &ndash; peewee 入门教程</title>

</head>
<body>

  <aside>
    <div>
      <a href="http://www.shushilvshe.com">
        <img src="http://www.shushilvshe.com/images/self.jpg" alt="数食旅摄" title="数食旅摄">
      </a>
      <h1><a href="http://www.shushilvshe.com">数食旅摄</a></h1>

<p>Data Developer</p>
      <nav>
        <ul class="list">
          <li><a href="http://www.shushilvshe.com/pages/about.html#about">About ME</a></li>

          <li><a href="/categories.html" target="_blank">Category</a></li>
          <li><a href="/tags.html" target="_blank">Tags</a></li>
          <li><a href="/archives.html" target="_blank">Archives</a></li>
        </ul>
      </nav>

      <ul class="social">
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="http://www.shushilvshe.com">    Home
</a>

      <a href="/category/data.html">Data</a>
      <a href="/category/food.html">Food</a>
      <a href="/category/travel.html">Travel</a>
      <a href="/category/lulu_qixi/lulu_qixi.html">Qixi</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="python/peewee">peewee 入门教程</h1>
    <p>
          Posted on 2017-08-31(星期四) 20:04 in <a href="http://www.shushilvshe.com/category/data.html">Data</a>


    </p>
  </header>


  <div>
    <h2>简介</h2>
<p>peewee是一款轻量级、丰富的ORM（Object Relation Mapping，对象关系映射），支持 <strong><code>postgresql</code></strong>、<strong><code>mysql</code></strong> 和 <strong><code>sqlite</code></strong>。</p>
<p>大量的插件支持：</p>
<ul>
<li>Postgresql HStore，Json，Arrays</li>
<li>SQLite全文搜索、自定义函数、虚拟表格</li>
<li>结构迁移和model代码生成器</li>
<li>连接池</li>
<li>加密</li>
<li>连表查</li>
<li>单表原生sql接口</li>
</ul>
<h2>模型定义</h2>
<p>模型类、字段以及模型实例与数据的对于关系：</p>
<table>
<thead>
<tr>
<th>peewee</th>
<th>数据库</th>
</tr>
</thead>
<tbody>
<tr>
<td>Model class</td>
<td>Database table</td>
</tr>
<tr>
<td>Field instance</td>
<td>Column on a table</td>
</tr>
<tr>
<td>Model instance</td>
<td>Row in a database table</td>
</tr>
</tbody>
</table>
<p>开始一个peewee的项目时，通常最好通过定义一个或多个 Model classes: 来开始你的数据模型。</p>
<ul>
<li>
<p>连接数据库</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s1">&#39;people.db&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">birthday</span> <span class="o">=</span> <span class="n">DateField</span><span class="p">()</span>
    <span class="n">is_relative</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span> <span class="c1"># This model uses the &quot;people.db&quot; database.</span>
</pre></div>


<blockquote>
<p><strong>关于Meta类:</strong> 简单来说定义了一个表的元数据信息，比如数据库，表名，主键，排序等信息，具体参照 <a href="http://docs.peewee-orm.com/en/latest/peewee/models.html#model-options-and-table-metadata"><strong>Meta</strong></a></p>
<p><strong>关于fieldTye:</strong> 字段类型，所有支持的字段类型参照 <a href="http://docs.peewee-orm.com/en/latest/peewee/models.html#field-types-table"><strong>FieldType</strong></a></p>
</blockquote>
<p>有许多 field types 适用于存储各种类型的数据，Peewee可以自动的转换python中的值到数据库中使用，所以你不用担心代码中Python的类型。</p>
<p>当我们通过使用 <code>外键</code> 来创建关联模型的时候非常有趣，使用peewee将变得非常简单：    </p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">Pet</span>(<span class="n">Model</span>):
<span class="n">owner</span> = <span class="n">ForeignKeyField</span>(<span class="n">Person</span>, <span class="n">related_name</span>=<span class="s">&#39;pets&#39;</span>)
<span class="nb">name</span> = <span class="n">CharField</span>()
<span class="n">animal_type</span> = <span class="n">CharField</span>()

<span class="k">class</span> <span class="n">Meta:</span>
    <span class="n">database</span> = <span class="n">db</span> <span class="c c-Singleline"># this model uses the &quot;people.db&quot; database</span>
</pre></div>


<p>现在我们有了模型，接下来连接数据库吧，<strong>虽然没有必要建立显示连接，这是个好的习惯</strong>，一旦发现连接数据发送错误，便可以排除之后的查询错误，当处理完毕后应当关闭连接。比如：一个web应用程序当收到请求的时候可能会打开一个连接，响应后将关闭连接。</p>
<div class="highlight"><pre><span></span>db.connect()
</pre></div>


<p>然后我们在数据库中传接用于存储我们数据的表，这将创建具有相应列、索引、自增键以及外键：</p>
<div class="highlight"><pre><span></span>db.create_tables([Person, Pet])
</pre></div>


</li>
</ul>
<h2>存储数据</h2>
<p>接下来我们用一些人填充数据库吧，可以使用 <strong><code>save()</code></strong> 与 <strong><code>create()</code></strong> 方法添加和更新人的记录。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="n">uncle_bob</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="n">birthday</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">1960</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">is_relative</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">uncle_bob</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c1"># bob is now stored in the database</span>
<span class="mi">1</span>
</pre></div>


<blockquote>
<p>当你调用 save() 的时候，将返回影响到的行数。<br>
你也可以调用 create() 方法新增一个人，它将返回一个模型实例：</p>
</blockquote>
<div class="highlight"><pre><span></span>grandma = Person.create(name=&#39;Grandma&#39;, birthday=date(1935, 3, 1), is_relative=True)
herb = Person.create(name=&#39;Herb&#39;, birthday=date(1950, 5, 5), is_relative=False)
</pre></div>


<blockquote>
<p>插入数据也可用 <strong><code>insert()</code></strong> 方法</p>
</blockquote>
<div class="highlight"><pre><span></span>Person.insert(name=&#39;Grandma&#39;, birthday=date(1935, 3, 1), is_relative=True).execute()
</pre></div>


<blockquote>
<p>另外，如果想实现 <code>insert or update</code> ,可以使用 <strong><code>upsert()</code></strong> 方法【目前只支持sqlite和mysql】，使用方法：</p>
</blockquote>
<div class="highlight"><pre><span></span>Person.insert(name=&#39;Grandma&#39;, birthday=date(1935, 3, 1), is_relative=True).upsert().execute()
</pre></div>


<blockquote>
<p>如果想实现 <code>get or create</code> 方法，可参考 <strong><a href="http://docs.peewee-orm.com/en/latest/peewee/api.html?highlight=create_or_get">get_or_create()</a></strong> </p>
</blockquote>
<p>为了更新一行，可以修改模型实例，调用 <strong><code>save()</code></strong> 来保存更改。这里我们将改变Grandma名字，然后存储到数据库：</p>
<div class="highlight"><pre><span></span>grandma.name = &#39;Grandma L.&#39;
grandma.save()  # Update grandma&#39;s name in the database.
1
</pre></div>


<p>现在我们已经在数据库中保存了3个人了，接下来给他们一些宠物吧。Grandma不喜欢宠物在屋子里乱跑，所以她一只都没有，但Herb是个宠物达人：</p>
<div class="highlight"><pre><span></span>bob_kitty = Pet.create(owner=uncle_bob, name=&#39;Kitty&#39;, animal_type=&#39;cat&#39;)
herb_fido = Pet.create(owner=herb, name=&#39;Fido&#39;, animal_type=&#39;dog&#39;)
herb_mittens = Pet.create(owner=herb, name=&#39;Mittens&#39;, animal_type=&#39;cat&#39;)
herb_mittens_jr = Pet.create(owner=herb, name=&#39;Mittens Jr&#39;, animal_type=&#39;cat&#39;)
</pre></div>


<p>在经历很长的一段生活后，Mittens生病死了，我们需要将它从数据库中移出：</p>
<div class="highlight"><pre><span></span>herb_mittens.delete_instance() # he had a great life
1
</pre></div>


<blockquote>
<p>delete_instance() 可删除一行数据，并且可选择性的递归删除所引用的对象； delete可删除多行，具体可参考 <a href="http://docs.peewee-orm.com/en/latest/peewee/querying.html#deleting-records"><strong>delete</strong></a></p>
</blockquote>
<p>Bob叔叔考虑到Herb家已经死了许多宠物，决定收养Fido：</p>
<div class="highlight"><pre><span></span>herb_fido.owner = uncle_bob
herb_fido.save()
bob_fido = herb_fido # rename our variable for clarity
</pre></div>


<h2>检索数据</h2>
<p>参考： <a href="http://docs.peewee-orm.com/en/latest/peewee/querying.html#query-operators"><strong>查询操作符及对应函数</strong></a></p>
<p>数据库的强大之处在于允许我们通过 查询 来检索数据，关系型数据库针对点对点查询非常优异。</p>
<ul>
<li>获取单条数据</li>
</ul>
<p>让我们从数据库中获取Grandma的数据，使用 SelectQuery.get() 来从数据库中获取单条数据：</p>
<div class="highlight"><pre><span></span>grandma = Person.select().where(Person.name == &#39;Grandma L.&#39;).get()
</pre></div>


<p>我们也可以等价简写成 Model.get() ：</p>
<div class="highlight"><pre><span></span>grandma = Person.get(Person.name == &#39;Grandma L.&#39;)
</pre></div>


<ul>
<li>获取记录列表</li>
</ul>
<p>获取数据库中的所有人：</p>
<div class="highlight"><pre><span></span>for person in Person.select():
    print person.name, person.is_relative

Bob True
Grandma L. True
Herb False
</pre></div>


<p>获取数据库中所有猫以及主人的名字：</p>
<div class="highlight"><pre><span></span>query = Pet.select().where(Pet.animal_type == &#39;cat&#39;)
for pet in query:
    print pet.name, pet.owner.name

Kitty Bob
Mittens Jr Herb
</pre></div>


<p>上一个查询是有问题的：因为我们访问了 pet.owner.name，但我们并没有在原始查询中进行查询，peewee 不得不进行一个额外的查询来检索宠物的主人，该行为请参考 N+1 ，通常这应当避免的。</p>
<p>为了避免额外的查询，我们可以通过添加 join 来同时查询 Pet 和 Person。</p>
<div class="highlight"><pre><span></span>query = (Pet
         .select(Pet, Person)
         .join(Person)
         .where(Pet.animal_type == &#39;cat&#39;))
for pet in query:
    print pet.name, pet.owner.name

Kitty Bob
Mittens Jr Herb
</pre></div>


<p>获取Bob的所有宠物</p>
<div class="highlight"><pre><span></span>for pet in Pet.select().join(Person).where(Person.name == &#39;Bob&#39;):
    print pet.name

Kitty
Fido
</pre></div>


<p>我们还可以做另外一件很酷的事情来获取Bob的宠物，一旦拥有可以代表Bob的对象，我们可以这样替代：</p>
<div class="highlight"><pre><span></span>for pet in Pet.select().where(Pet.owner == uncle_bob):
    print pet.name
</pre></div>


<p>可以通过 order_by() 语句来排序:</p>
<div class="highlight"><pre><span></span>for pet in Pet.select().where(Pet.owner == uncle_bob).order_by(Pet.name):
    print pet.name

Fido
Kitty
</pre></div>


<p>获取有所人，并且按照年龄从小到大排序：</p>
<div class="highlight"><pre><span></span>for person in Person.select().order_by(Person.birthday.desc()):
    print person.name, person.birthday

Bob 1960-01-15
Herb 1950-05-05
Grandma L. 1935-03-01
</pre></div>


<p>获取所有人 以及 他们宠物的一些信息：</p>
<div class="highlight"><pre><span></span>for person in Person.select():
    print person.name, person.pets.count(), &#39;pets&#39;
    for pet in person.pets:
        print &#39;    &#39;, pet.name, pet.animal_type

Bob 2 pets
    Kitty cat
    Fido dog
Grandma L. 0 pets
Herb 1 pets
    Mittens Jr cat
</pre></div>


<p>我们再一次运行了典型的 N+1 查询行为，可以进行 JOIN 操作并且合并起来：</p>
<div class="highlight"><pre><span></span>subquery = Pet.select(fn.COUNT(Pet.id)).where(Pet.owner == Person.id)
query = (Person
         .select(Person, Pet, subquery.alias(&#39;pet_count&#39;))
         .join(Pet, JOIN.LEFT_OUTER)
         .order_by(Person.name))

for person in query.aggregate_rows():  # Note the `aggregate_rows()` call.
    print person.name, person.pet_count, &#39;pets&#39;
    for pet in person.pets:
        print &#39;    &#39;, pet.name, pet.animal_type

Bob 2 pets
     Kitty cat
     Fido dog
Grandma L. 0 pets
Herb 1 pets
     Mittens Jr cat
</pre></div>


<p>甚至我们创建了单独的子查询，但只执行了 有且仅有一个 查询。</p>
<p>最后我们处理一个复杂一点的，获取所有人，只要他们的生日：</p>
<ul>
<li>1940之前 (grandma)</li>
<li>
<p>1959之后 (bob)</p>
<p>d1940 = date(1940, 1, 1)
d1960 = date(1960, 1, 1)
query = (Person
         .select()
         .where((Person.birthday &lt; d1940) | (Person.birthday &gt; d1960)))
for person in query:
    print person.name, person.birthday</p>
<p>Bob 1960-01-15
Grandma L. 1935-03-01</p>
</li>
</ul>
<p>现在在做一件相反的事情，获取1940到1960之间的人：</p>
<div class="highlight"><pre><span></span>query = (Person
         .select()
         .where((Person.birthday &gt; d1940) &amp; (Person.birthday &lt; d1960)))

for person in query:
    print person.name, person.birthday

Herb 1950-05-05
</pre></div>


<p>最后一次查询，使用SQL函数来检索所有名字以 G 开头的人，不区分大小写：</p>
<div class="highlight"><pre><span></span>expression = (fn.Lower(fn.Substr(Person.name, 1, 1)) == &#39;g&#39;)
for person in Person.select().where(expression):
    print person.name

Grandma L.
</pre></div>


<p>我们已经处理完数据库，最后关闭连接：</p>
<div class="highlight"><pre><span></span>db.close()
</pre></div>


<p>这些都是基础的使用，你可以进行更加复杂的操作。</p>
<p>所有其他的一些SQL语句也是可用的，比如：</p>
<ul>
<li>group_by()</li>
<li>having()</li>
<li>limit()</li>
<li>offset()</li>
</ul>
<h2>附录</h2>
<p><strong>python其他ORM框架：</strong></p>
<ul>
<li>
<p><a href="https://www.sqlalchemy.org/"><strong>SQLAlchemy</strong></a>  企业级ORM框架，重量级</p>
</li>
<li>
<p><a href="https://ponyorm.com/"><strong>Pony</strong></a> 可使用Python <code>生成式</code> &amp; <code>lambdas</code>, 语法超简洁</p>
</li>
<li>
<p><a href="http://python.jobbole.com/84100/"><strong>Python几个ORM框架对比</strong></a></p>
</li>
<li>
<p><a href="http://docs.peewee-orm.com/en/latest/index.html"><strong>官方网站</strong></a></p>
</li>
<li>
<p><a href="http://docs.peewee-orm.com/en/latest/peewee/api.html"><strong>API Reference</strong></a></p>
</li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://www.shushilvshe.com/tag/python.html">python</a>
      <a href="http://www.shushilvshe.com/tag/orm.html">ORM</a>
    </p>
  </div>



    <div class="addthis_relatedposts_inline">


</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " shushilvshe's Blog ",
  "url" : "http://www.shushilvshe.com",
  "image": "http://www.shushilvshe.com/images/self.jpg",
  "description": "shushilvshe's Thoughts and Writings"
}
</script>

</body>
</html>